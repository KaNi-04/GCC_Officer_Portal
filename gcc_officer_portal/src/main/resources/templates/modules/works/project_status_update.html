<!DOCTYPE html>
<html lang="en" dir="">
<html xmlns:th="http://www.thymeleaf.org">
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

<head th:replace="~{fragments/modules/base/head :: head}"></head>
<style>
    .is-invalid {
        border: 2px solid red !important;
        background-color: #ffcccc !important;
    }

    .checkbox-large {
        width: 20px;
        height: 20px;
    }

    .readonly-select {
        pointer-events: none; /* Prevent user interaction */
        background-color: #e9ecef; /* Light grey background (like disabled) */
    }
</style>

<body>
<link rel="stylesheet" type="text/css"
      href="node_modules/jquery.datetimepicker/jquery.datetimepicker.css"/>
<!--[if lt IE 8]>
<p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade
    your browser</a> to improve your experience.</p>
<![endif]-->

<div class="wrapper">
    <!-- header top menu Start -->
    <header th:replace="~{fragments/modules/base/header :: header}"></header>
    <!-- header top menu end -->

    <div class="page-wrap">
        <!--=============== Left Menu side Start ================-->
        <div th:replace="~{fragments/modules/base/menu :: menu}"></div>
        <!--=============== Left side End ================-->
        <div class="main-content">
            <div class="container-fluid">
                <div class="page-header">
                    <div class="row align-items-end">
                        <div class="col-lg-8">
                            <div class="page-header-title">
                                <i class="far fa-calendar-plus bg-blue"></i>
                                <div class="d-inline">
                                    <h5>List of Projects</h5>
                                    <span>Project Status</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <nav class="breadcrumb-container" aria-label="breadcrumb">
                                <ol class="breadcrumb">
                                    <li class="breadcrumb-item"><a href="index"><i
                                            class="ik ik-home"></i></a></li>
                                    <li class="breadcrumb-item" aria-current="page">Project Status
                                    </li>
                                    </li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                </div>
                <hr>

                <div class="col-md-14">
                    <div class="card p-3">
                        

                        <div class="row">
                            <div class="col-md-12">
                                <label for="projectid">Select Project: <font style="color: red">*</font></label> 
                                <select class="form-control" id="projectid">
	                                <option value="" >Select project</option>
	                                <option th:each="project : ${projects}" 
								            th:value="${project.pid}" 
								            th:text="${project.name}">
								    </option>
                            	</select>
                            </div>
                            
                            <div class="col-md-12">
                                <label for="filterType">Project Status: <font style="color: red">*</font></label> 
                                <textarea class="form-control" id="statustxt"></textarea>
                            </div>
                            
                            <div class="col-md-12">
                                <label for="filterType">Photo / File: <font style="color: red">*</font></label> 
                                <input name="projectfile" id="projectfile" class="form-control"
                                                       type="file" capture="camera" accept="application/pdf, image/*" required>
                            </div>
                            
                            <div class="col-md-2 d-flex align-items-end gap-2">
                                <button id="submitFilter" class="btn btn-primary" onclick="save_project_data()">Submit</button>
                                <button class="btn btn-danger mt-2" onclick="resetpage()"
                                        name="reset" type="reset">Reset
                                </button>
                                <!--<button type="button" class="btn btn-sm btn-success mt-2" name="downloadBtn"
                                        onclick="downloadExcel()">Download Excel</button>-->
                            </div>
                        </div>
                       
                    </div>
                </div>
                <br>
                <div class="row">
                    <div class="card-block">
                    <div id="tableLoading"></div>
                        <div>
                            <table id="worksDatatable"
                                   class="table table-striped table-bordered table-hover"
                                   width="99.5%">
                               
                                <thead class="thead-dark">
                                <tr>
                                    <th>S.No</th>
                                    <th>Type</th>
                                    <th>Department</th>
                                    <th>Project Name</th>
                                    <th>Status</th>
                                    <th>Photo/File</th>
                                    <th>Updated Date</th>
                                </tr>
                                </thead>
                                <tbody>
                                
                                </tbody>
                            </table>

                            <!-- Pagination Controls -->
                            <div class="pagination-container">
                                <div
                                        class="d-flex justify-content-between align-items-center my-3">
                                    <span id="entriesInfo" class="text-muted"></span>
                                    <ul id="pagination" class="pagination mb-0"></ul>
                                </div>
                                <ul class="pagination justify-content-center"
                                    style="justify-content: right !important;" id="pagination"></ul>
                            </div>

                        </div>
                    </div>
                </div>

            </div>

            <footer th:replace="~{fragments/modules/base/footer :: footer}"></footer>
        </div>
    </div>
</div>

	<div th:replace="~{fragments/modules/works/modal-box :: div}"></div> 
	
    <div th:replace="~{fragments/modules/base/app_module_menu_box :: div}"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script th:replace="~{fragments/modules/base/script :: script}"></script>
    <script th:replace="~{fragments/modules/works/script :: script}"></script>
    
    <script src="node_modules/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script src="node_modules/amcharts3/amcharts/amcharts.js"></script>
    <script src="node_modules/amcharts3/amcharts/serial.js"></script>
    <script src="node_modules/amcharts3/amcharts/themes/light.js"></script>
    <script src="node_modules/jquery.datetimepicker/jquery.datetimepicker.full.min.js"></script>
    <script th:inline="javascript">
        var loginUserID = /*[[${LoginUserId}]]*/'';
        var createdBy = /*[[${LoginUserId}]]*/'';
        
        var loading_text_msg = getLoadingMessage(); // get Random loading message from base/script
        
     	// Loading Div id
    	const loading = $("#tableLoading");
     	
    	// DataTables buttons configuration
        var buttons = [
        	{
				extend: 'pageLength',
				className: 'btn btn-warning'
			},
            {
				title: 'Data export',
                extend: 'copyHtml5',
                text: 'Copy',
                className: 'btn btn-secondary',
                id: 'copyBtn'
            },
            {
                extend: 'excelHtml5',
                text: 'Excel',
                className: 'btn btn-secondary',
                id: 'excelBtn',
                title: 'Project List'
            },
            {
                extend: 'csvHtml5',
                text: 'CSV',
                className: 'btn btn-secondary',
                id: 'csvBtn',
                title: 'Project List'
            },
            {
                extend: 'pdfHtml5',
                text: 'PDF',
                className: 'btn btn-secondary',
                id: 'pdfBtn',
                title: 'Project List'
            },
            {
                extend: 'print',
                text: 'Print',
                className: 'btn btn-secondary',
                id: 'printBtn',
                title: 'Project List',
                exportOptions: {
                    columns: ':visible:not(.no-print)' // Exclude columns with class 'no-print' from print view
                }
            },
            {
				extend: 'colvis',
				className: 'btn btn-warning'
			},
        ];
		
    	
        function call_loading(){
			loading.html(searchinfo("<b>"+loading_text_msg+"</b>"));
		}
		
		function remove_loading(){
			loading.html("");
		}
		
        /* 
        	===============================================================================================
        	===============================================================================================
        */
        
        function form_btn_enable() {
            $("#resetFormBtn").prop("disabled", false);
            $("#requestSubmitBtn").prop("disabled", false);
            $("#requestSubmitBtn").html('<i class="ik ik-save"></i>Save');
        }

        function form_btn_disable() {
            $("#resetFormBtn").prop("disabled", true);
            $("#requestSubmitBtn").prop("disabled", true);
            // Show the loading icon on the button
            $("#requestSubmitBtn").html('<i class="fas fa-spinner fa-spin"></i> Validating your request, please wait...');
        }

        function validateEndDate() {
            const startDate = document.getElementById('fromDate').value;
            const endDateInput = document.getElementById('toDate');

            if (startDate) {
                const startDateObj = new Date(startDate);
                const minEndDateISO = startDateObj.toISOString().split('T')[0];
                endDateInput.setAttribute('min', minEndDateISO);

                // Clear endDate if it's less than startDate
                if (endDateInput.value && new Date(endDateInput.value) < startDateObj) {
                    endDateInput.value = '';
                }
            }
        }

        /*
        =========================================================================================
        */

        
        /* Get works data List */
        function get_project_list(){
        	
        	call_loading();
        	var table = $('#worksDatatable').DataTable();
        	table.clear();
        	// Destroy the DataTable before reinitializing
        	table.destroy();
        	
        	
        	get_erp_work_data().then(function(erpWorksDataList) {
    		    // Handle the data list
    		    generate_table(erpWorksDataList);
    		    
    		}).catch(function(error) {
    		    // Handle errors
		        if (error && error.message) {
		            console.error('Error fetching project data list:', error.message);
		        } else {
		            console.error('An error occurred while fetching project data list:', error);
		        }
    		});
		}
        
        /* Get Erp works Data */
        async function get_erp_work_data() {

        	
        	var apiUrl = '/gcc/works/api/estimates/getProjectUpdatedList?loginid='+createdBy;
    	    // Return a Promise
    	    return new Promise(function(resolve, reject) {
    	        $.ajax({
    	            url: apiUrl,
    	            type: 'GET',
    	            dataType: 'json',
    	            success: function(jsonResponse) {
    	                // Resolve the Promise with the department list
    	                resolve(jsonResponse);
    	            },
    	            error: function(xhr, status, error) {
    	                // Reject the Promise with the error message
    	                reject(error);
    	            }
    	        });
    	    });
        }
        
        /* Call DataTable function */
        function generate_table(data){
        	var table = $('#worksDatatable').DataTable();

        	// Destroy the DataTable before reinitializing
        	table.destroy();

        	// Now, reinitialize the table
        	table = $('#worksDatatable').DataTable({
        	    dom: 'Bftip',
        	    deferRender: true,  // Delays rendering of non-visible rows
        	    columnDefs: [
        	        { targets: 'no-sort', "orderable": false },
        	        { targets: 'no-exportable', "exportable": false }
        	    ],
        	    lengthMenu: [
        	        [50, 100, 200, 500, -1],
        	        ['50 rows', '100 rows', '200 rows', '500 rows', 'Show all']
        	    ],
        	    fixedColumns: {
        	        left: 0,
        	        right: 0
        	    },
        	    buttons: [buttons],
        	    responsive: false,
        	    searching: true,
        	    select: false,
        	    processing: true, // Enables processing indicator
        	});
            
        	// Clearn Table data
        	table.clear();
        	            
        	// Add rows to DataTable
        	var rowNum = 1;
        	$.each(data, function(index, row) {
        	    /*
        		actionHTML = `<div class="dropdown d-inline-block show">
        	                     <a class="nav-link dropdown-toggle text-warning" href="#" id="moreDropdown" role="button" 
        	                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" data-animation="true" 
        	                    data-placement="top" data-html="true" title="`+row['ESTIMATE_NO']+`" >`+row['ESTIMATE_NO']+`</a>
        	                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="moreDropdown" x-placement="bottom-end">
        	                    	<a class="dropdown-item" href="" onclick="return viewWorksSummary('`+row['id']+`');" data-animation="true" data-toggle="tooltip" data-placement="top" data-html="true" title="View Full Details"><i class="ik ik-printer"></i> View Details</a>
        	                    	<a class="dropdown-item" href="" onclick="return updateWorksSummary('`+row['id']+`');" data-animation="true" data-toggle="tooltip" data-placement="top" data-html="true" title="Update Details"><i class="ik ik-edit"></i> Update Details</a>
        	                    </div>
        	              </div>`;
        	              */
        	              
        	    //actionHTML = row['ESTIMATE_NO'];
        	    
        	    table.row.add([
        	        rowNum++,
        	        row['type'],
        	        row['department'],
        	        row['name'],
        	        row['status'],
        	        row['file'],
        	        row['lastupdatedate'],
        	        
        	    ]);
        	});
        	
        	

        	// **Call draw() only once**
        	table.draw(false);
            
            // Enable tooltips for all elements with data-toggle="tooltip"
            $('[data-toggle="tooltip"]').tooltip();
            remove_loading(); // remove Loading 
		}
        
        function formatDBDate(inputDate) {
            let parts = inputDate.split("-");
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1]}-${parts[0]}`; // Convert to YYYY-MM-DD
            }
            return inputDate; // Return as-is if format is incorrect
        }
        
        function save_project_data(){
        	let formData = new FormData();
        	
        	// Append form fields
            //formData.append("estid", estid);
            formData.append("loginid", loginUserID);
         	// Append files (only if a file is selected)
         	
         	
         	let projectid = document.getElementById("projectid");
            let projectidValue = projectid.value; // Get selected value

	         // Validate selected
	         if (!projectidValue) {
	             Swal.fire({
	                 title: "Error",
	                 text: "Please select a project before submission.",
	                 icon: "error",
	                 confirmButtonText: "OK"
	             });
	             return; // Stop execution if not selected
	         }
            
	        formData.set("pid", projectidValue);
            
         	let statustxt = document.getElementById("statustxt");
         	let statustxtValue = statustxt.value; // Get selected value

	         // Validate selection
	         if (!statustxtValue) {
	             Swal.fire({
	                 title: "Error",
	                 text: "Please add project status.",
	                 icon: "error",
	                 confirmButtonText: "OK"
	             });
	             return; // Stop execution if not selected
	         }

         	// Set the form data
         	formData.set("status", statustxtValue);
         	
         	// Get file inputs
		    
		    let projectFile = $("#projectfile")[0].files[0];
		    formData.append("projectfile", projectFile);
            
            $.ajax({
                url: "/gcc/works/api/estimates/saveProjectStatus",
                type: "POST",
                contentType: false,
                processData: false,
                data: formData,
                success: function (response) {
                    // console.log(formData);
                    Swal.fire({
                        title: "Updated!",
                        text: "Project status have been updated successfully.",
                        icon: "success",
                        confirmButtonText: "OK",
                    }).then(() => {
                        location.reload();
                    });
                },
                error: function (xhr, status, error) {
                    // console.log(xhr.responseText);
                    Swal.fire({
                        title: "Error",
                        text: "Failed to update project." + "Error: " + error + "\nStatus: " + status + "\nResponse: " + xhr.responseText,
                        icon: "error",
                        confirmButtonText: "OK",
                    });
                }
            });
        	
        }
        
        /*
        	===============================================================
        */
        
        $(document).ready(function () {
        	//call_loading();
           // loadWardsFilter();
           // loadDepartmentFilter();
           // loadSourceFilter();
            get_project_list();
        });
        
    </script>
</body>

</html>