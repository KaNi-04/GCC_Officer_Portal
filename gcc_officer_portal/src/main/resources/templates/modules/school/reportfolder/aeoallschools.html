<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/modules/base/head :: head}">

</head>
<style>
#DetailsModal .modal-body {
			                max-height: 80vh;  /* Limit the height to 70% of the viewport */
			                overflow-y: auto;  /* Enable vertical scrolling */
			            }
</style>
<body>
	<div class="wrapper">

		<!-- header top menu Start -->
		<header th:replace="~{fragments/modules/base/header :: header}"></header>
		<!-- header top menu end -->
		<div class="page-wrap">
			<!--=============== Left Menu side Start ================-->
			<div th:replace="~{fragments/modules/base/menu :: menu}"></div>
			<!--=============== Left side End ================-->


			<div class="main-content">
				<div class="container-fluid">
					<div class="page-header mb-2">
						<div class="row align-items-end">
							<div class="col-lg-8">
								<div class="page-header-title">
									<i class="fa fa-list-alt bg-blue"></i>
									<div class="d-inline">
										<h5>Schools Reports</h5>
										<span>Reports based on Student Enrollment of all or specific AEO</span>
									</div>
								</div>
							</div>
							<div class="col-lg-4">
								<nav class="breadcrumb-container" aria-label="breadcrumb">
									<ol class="breadcrumb">
										<li class="breadcrumb-item"><a href="/gcc/index"><i
												class="ik ik-home"></i></a></li>
										<li class="breadcrumb-item" aria-current="page">School</li>
										<li class="breadcrumb-item" aria-current="page">Student Enroll Report</li>
										<li class="breadcrumb-item active" aria-current="page">AEO School wise</li>
									</ol>
								</nav>
							</div>
						</div>
					</div>
					
					
					<div class="row mt-4">
						<div class="col-12">
							<div class="card">
								<div class="card-header">
									<span style="font-size: medium;font-weight: bold;">Reports Filters</span>
								</div>
								<div class="card-body">
									
									<div class="row">																																								
										<div class="col-sm-2 mb-2">
								            <label for="aeodropdown" style="font-size: medium;">Select AEO:</label>
								            <select id="aeodropdown" class="form-control">
								            <option value="">All</option>
								               
											</select>
										</div>
																																																			
										
										</div>
										
									
									
									<!-- <div class="row mt-4">
										<div class="col-12 d-flex justify-content-center">
											<button type="submit" id="searchBtn"
												class="btn btn-primary mx-2">Search</button>

											<button class="btn btn-danger mx-2" id="resetBtn"
												name="reset" type="reset">Reset</button>
										</div>
									</div> -->
									
								</div>
							</div>
						</div>
					</div>
			
					
					<div class="row mt-4">
									<div class="col-md-12">
										<div class="card">
										<div class="card-header">
											<span style="font-size: medium;font-weight: bold;">Reports List</span>
										</div>
										<div class="card-body">
												<div class="table-responsive">
	
													<table id="ReportDatatable"
														class="table table-striped table-bordered table-hover dataTable"
														role="grid">
														<thead class="thead-dark">
															<tr role="row">
																<th class="text-center no-sort">S.No</th>
																<th class="text-center">UDISE code</th>
																<th class="text-center" style="width: 100px;">AEO</th>
																<th class="text-center">Zone</th>
																<th class="text-center">Division</th>
																<th class="text-center">School Name</th>
																<th class="text-center">HM Name</th>
																<th class="text-center">HM Mobile no</th>																
																<th class="text-center">Total Students</th>															
																<th class="text-center">Enrolled Students</th>	
																<th class="text-center">Pending Students</th>														
															</tr>
														</thead>
														<tbody>
	
														</tbody>
													</table>
												</div>
										</div>
									 </div>
									</div>
								</div>
					
				</div>

			</div>

			<div id="pageLoader" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 9999; text-align: center;">
				    <div style="position: relative; top: 50%; transform: translateY(-50%);">
				        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
				            <span class="sr-only">Loading...</span>
				        </div>
				        <!-- Add the 'Please wait' text below the spinner -->
				        <p style="margin-top: 1rem; font-size: 1.2rem; color: #007bff;">Please wait...</p>
				    </div>
				</div>

			<footer th:replace="~{fragments/modules/base/footer :: footer}"></footer>
		</div>
	</div>


<div class="modal fade" id="DetailsModal" tabindex="-1" aria-labelledby="DetailsLabel" aria-hidden="true">
	    <div class="modal-dialog modal-xl">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title" id="DeatilsModalTitle">Details</h5>
	                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
			                    <span aria-hidden="true">&times;</span>
			                </button>
	            </div>
	            <div class="modal-body">
	                
	                <table id="DetailsDatatable" class="table table-striped table-bordered table-hover dataTable"
					role="grid">
	                   <thead class="thead-dark">
				        <tr role="row">
				            <th class="text-center">S.no</th>
				            <th class="text-center">Reg Date</th>
				            <th class="text-center">Student Name</th>
				            <th class="text-center">Class</th>
				            <th class="text-center">EMIS no</th>				            				            				            
				            
				        </tr>			        
				        </thead>
				        <tbody>
				
				
				        </tbody>
	                </table>
	                
	            </div>
	        </div>
	    </div>
	</div>



	<script th:replace="~{fragments/modules/base/script :: script}"></script>
	<!--  sweet alert -->
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	
	<script type="text/javascript">
	document.addEventListener("DOMContentLoaded", function () {
		
		 const urlParams = new URLSearchParams(window.location.search);
		 const aoeParam = urlParams.get('aoe');
		 console.log("Transfer aeo="+aoeParam);
		
		//fetchAEOStudentData([]);
	    
	    let aeoDropdown = document.getElementById('aeodropdown');
	    	    
	    fetch('/gcc/api/gccschool/report/getAEOList') 
	        .then(response => response.json())
	        .then(data => {
	            // Clear existing options
	            aeoDropdown.innerHTML = `<option value="">All</option>`;

	            let matchedValue = null;
	            
	            // Add options from the API response
	            data.data.forEach(aeo => {
	            	
	            	// Check if aoeParam matches aeo.aeo_num
	                if (aoeParam && aeo.aeo_num === aoeParam) {
	                    matchedValue = aeo.udise;
	                    aeoDropdown.innerHTML += `<option value="${aeo.udise}" selected>${aeo.aeo_num}</option>`;
	                } else {
	                    aeoDropdown.innerHTML += `<option value="${aeo.udise}">${aeo.aeo_num}</option>`;
	                }
	            	
	            });
	            
	         	// Trigger change event if a match was found
	            if (matchedValue) {
	                aeoDropdown.dispatchEvent(new Event('change'));
	            } else {
	                fetchAEOStudentData([]); // fallback if no match or no param
	            }
	         	
	        })
	        .catch(error => {
	            console.error('Error fetching in AEO List:', error);
	        });
	    
	    document.getElementById('aeodropdown').addEventListener('change', function (e) {
  	 	    let aeovalue = this.value; // single selection

  	 	    if (!aeovalue) {
  	 	    	fetchAEOStudentData([]);
  	 	    	return;
  	 	    }

  	 	    // If selected, call fetchAEOStudentData with selected value
  	 	    fetchAEOStudentData([aeovalue]); // wrap in array if your method expects array
  	 	});
	    
	    
	});
	
	 $(document).ready(function() {

		 var table = $('#ReportDatatable').DataTable({
             dom: 'Bftip',
             columnDefs: [
                 { targets: 'no-sort', orderable: false }
             ],
             lengthMenu: [
                 [50, 100, 200, 500, -1],
                 ['50 rows', '100 rows', '200 rows', 'Show all']
             ],
             scrollY: '80vh',
             scrollX: true,
             
             buttons: [
                 {
                     extend: 'pageLength',
                     className: 'btn btn-warning'
                 },
                 {
                     title: 'Data export',
                     extend: 'copyHtml5',
                     text: 'Copy',
                     className: 'btn btn-secondary',
                     id: 'copyBtn'
                 },
                 {
                     extend: 'excelHtml5',
                     text: 'Excel',
                     className: 'btn btn-secondary',
                     id: 'excelBtn'
                 },
                 {
                     extend: 'csvHtml5',
                     text: 'CSV',
                     className: 'btn btn-secondary',
                     id: 'csvBtn'
                 },
                 {
                     extend: 'pdfHtml5',
                     text: 'PDF',
                     className: 'btn btn-secondary',
                     id: 'pdfBtn'
                 }
             ],
             fixedHeader: true,
             autoWidth: true,
             responsive: false,
             searching: true,
             select: false,
             processing: false
         });
     	   
  	   
  	 	/* document.getElementById('resetBtn').addEventListener('click', function () {
      	event.preventDefault();
      	
      		location.reload();
      	
      	}); */
  	 	
/*   	 	document.getElementById('searchBtn').addEventListener('click', function (e) {
  	 		
  	 		let aeoDropdown = document.getElementById('aeodropdown');
	
  	 		
  		  
  		    let aeovalue = Array.from(aeoDropdown.selectedOptions).map(opt => opt.value);
  		  	    	         	   
    	   	console.log("aeovalue: ",aeovalue);

    	   
    	   if (!aeovalue || aeovalue.length === 0) {
    	        Swal.fire({
    	            icon: 'info',
    	            title: 'Info',
    	            text: 'Please Select AEO',
    	            showConfirmButton: true,
    	            timer: 3000
    	        });
    	        e.preventDefault(); 
    	        return; 
    	    }
    	   
    	   fetchAEOStudentData(aeovalue);  	   
    	   
  	 	}); */
  	 	
  	// Handle onchange of the dropdown
  	 	
      	$('#ReportDatatable tbody').off('click').on('click', 'td .clickable-students', function () {
      	    let udise = $(this).data('udise');
      	  	let schname = $(this).data('schname');
      	  
      	    console.log("Clicked UDISE:", udise,"school=",schname);

      	  openRegisteredDetails(udise,schname); 
      	});
  	 	
     	
     });
	 
	 function openRegisteredDetails(udise,schname){
		 
		 $('#pageLoader').show();
		 
		 $.ajax({
			    url: '/gcc/api/gccschool/report/getRegisteredStud',
			    method: 'GET',
			    data: {
			    	udise: udise			        
			    },
			    success: function (response) {

			    	$('#pageLoader').hide();
			    	console.log("Details:", response);
			    	if(response.Message==="Success"){
			        if (Array.isArray(response.Data) && response.Data.length > 0){
			        	
			        	let table = $('#DetailsDatatable').DataTable({
         	            	 destroy: true,
        	                searching: true,
        	                autoWidth: true,           	                
        	                paging: true,
        	                info: true,
         	                data: response.Data,       	             	
         	                columns: [
         	                	{ 
          	                        data: null, 
          	                        render: (data, type, row, meta) => meta.row + 1, 
          	                        className: 'text-center' 
          	                    },
          	                  {
          	                      data: 'cDate',
          	                      render: function (data, type, row) {
          	                        if (!data) return '-';

          	                        const date = new Date(data);
          	                        const day = String(date.getDate()).padStart(2, '0');
          	                        const month = String(date.getMonth() + 1).padStart(2, '0');
          	                        const year = date.getFullYear();
          	                        return `${day}/${month}/${year}`;
          	                      },
          	                      className: 'text-center'
          	                    },
			                    { data: 'student_name' ,className: 'text-center'},
			                    { data: 'std' ,className: 'text-center'}, 
			                    { data: 'emis_no' ,className: 'text-center'}
       	                    
         	                              	                      
         	                ],
         	                dom: 'Bfrtip',
         	                buttons: [
	      		                  {
	      		                      extend: 'pageLength',
	      		                      className: 'btn btn-warning'
	      		                  },
	      		                  {
	      		                      title: 'Data export',
	      		                      extend: 'copyHtml5',
	      		                      text: 'Copy',
	      		                      className: 'btn btn-secondary',
	      		                      id: 'copyBtn'
	      		                  },
	      		                  {
	      		                      extend: 'excelHtml5',
	      		                      text: 'Excel',
	      		                      className: 'btn btn-secondary',
	      		                      id: 'excelBtn'
	      		                  },
	      		                  {
	      		                      extend: 'csvHtml5',
	      		                      text: 'CSV',
	      		                      className: 'btn btn-secondary',
	      		                      id: 'csvBtn'
	      		                  },
	      		                  {
	      		                      extend: 'pdfHtml5',
	      		                      text: 'PDF',
	      		                      className: 'btn btn-secondary',
	      		                      id: 'pdfBtn'
	      		                  }
	      		              ],
	      		             columnDefs: [
	      		                { targets: 'no-sort', orderable: false }
	      		            ],
	      		            lengthMenu: [
	      		                [50, 100, 200, 500, -1],
	      		                ['50 rows', '100 rows', '200 rows', 'Show all']
	      		            ],
	      		         scrollY: '50vh',
	      		            scrollX: false,   	      		            
	      		       		responsive: false,
	                		searching: true
	      		            });
			        	
			        	
			        	
			        	
			        	$('#DeatilsModalTitle').text(schname +' Students Details');
			        	$('#DetailsModal').modal('show');
			        	$('#DetailsModal').on('shown.bs.modal', function () {
			        	    $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust();
			        	});
			        }
			    }
			        else if (response.Message === "Error") {
			        	$('#pageLoader').hide();
			      		//alert("No data available.");
			        	Swal.fire({
			 	            icon: 'error',
			 	            title: 'Error',
			 	            text: response.Error,
			 	            showConfirmButton: true,
			 	            timer: 3000
			 	        });
			        	
		     	         
			        } 
			        
			        else {
			        	$('#pageLoader').hide();
			            //alert("Error: " + response.message);
			        	Swal.fire({
			 	            icon: 'error',
			 	            title: 'Error',
			 	            text: 'Error',
			 	            showConfirmButton: true,
			 	            timer: 3000
			 	        });
		      	    	
		      	    	 
		     	        
			        }
			        
			    },
			    error: function (xhr, status, error) {
			    	$('#pageLoader').hide();
			        //alert("Request failed: " + error);
			    	Swal.fire({
		 	            icon: 'error',
		 	            title: 'Error',
		 	            text: error,
		 	            showConfirmButton: true,
		 	            timer: 3000
		 	        });
		  	    	
		  	    	 
		 	        
			    }
			});
	 }
	 
	 function fetchAEOStudentData(aeovalue)
	 {
		 let url = `/gcc/api/gccschool/report/getAEOStudentData`;
		    
		 if (aeovalue.length > 0) {
		        const params = new URLSearchParams();
		        aeovalue.forEach(val => {
		            console.log("Appending udise:", val);
		            params.append("udise", val);
		        });
		        url += `?${params.toString()}`;
		    } else {
		        // Explicitly send empty udise
		        url += `?udise=`;
		    }
  	   
  	   $('#pageLoader').show();
  	   $.ajax({
             type: "GET",
             url: url,
             contentType: "application/json",
             success: function (response) {
          	    console.log("API Response:", response);
          	    $('#pageLoader').hide();
          	    if (response.Message === "Success") {
          	        console.log("Details Array:", response.data);
          	        // Ensure details is an array and has at least one entry
          	        if (Array.isArray(response.data) && response.data.length > 0) {
          	        	 let scrollHeight = response.data.length <= 50 ? 'auto' : '80vh';
          	        	
          	            let table = $('#ReportDatatable').DataTable({
          	            	 destroy: true,
         	                searching: true,
         	                autoWidth: true,           	                
         	                paging: true,
         	                info: true,
          	                data: response.data,            	             	
          	                columns: [
          	                    { 
          	                        data: null, 
          	                        render: (data, type, row, meta) => meta.row + 1, 
          	                        className: 'text-center' 
          	                    },
          	                  	{ data: 'udise', defaultContent: '-', className: 'text-center' },
          	                    { data: 'aeo_num', defaultContent: '-', className: 'text-center' },
          	                  	{ data: 'zone', defaultContent: '-', className: 'text-center' },
          	                	{ data: 'division', defaultContent: '-', className: 'text-center' },
          	                  	{ data: 'school_name', defaultContent: '-', className: 'text-center' },
          	                	{ data: 'hm_name', defaultContent: '-', className: 'text-center' },
          	              		{ data: 'hm_mobile', defaultContent: '-', className: 'text-center' },          	                    
          	                    { data: 'total_students', defaultContent: '-', className: 'text-center' },
          	                    
          	                  {
          	                      data: 'students_registered',
          	                      defaultContent: '-',
          	                      className: 'text-center',
          	                      render: function (data, type, row) {
          	                        if (parseInt(data) > 0) {
          	                          return `<span class="clickable-students text-primary" style="cursor: pointer; text-decoration: underline;" data-udise="${row.udise}"data-schname="${row.school_name}">${data}</span>`;
          	                        } else {
          	                          return data;
          	                        }
          	                      }
          	                    },
          	                    
          	                  	{ data: 'pending', defaultContent: '-', className: 'text-center' }
          	                    
          	                              	                      
          	                ],
          	                dom: 'Bfrtip',
          	                buttons: [
 	      		                  {
 	      		                      extend: 'pageLength',
 	      		                      className: 'btn btn-warning'
 	      		                  },
 	      		                  {
 	      		                      title: 'Data export',
 	      		                      extend: 'copyHtml5',
 	      		                      text: 'Copy',
 	      		                      className: 'btn btn-secondary',
 	      		                      id: 'copyBtn'
 	      		                  },
 	      		                  {
 	      		                      extend: 'excelHtml5',
 	      		                      text: 'Excel',
 	      		                      className: 'btn btn-secondary',
 	      		                      id: 'excelBtn'
 	      		                  },
 	      		                  {
 	      		                      extend: 'csvHtml5',
 	      		                      text: 'CSV',
 	      		                      className: 'btn btn-secondary',
 	      		                      id: 'csvBtn'
 	      		                  },
 	      		                  {
 	      		                      extend: 'pdfHtml5',
 	      		                      text: 'PDF',
 	      		                      className: 'btn btn-secondary',
 	      		                      id: 'pdfBtn'
 	      		                  }
 	      		              ],
 	      		             columnDefs: [
 	      		                { targets: 'no-sort', orderable: false }
 	      		            ],
 	      		            lengthMenu: [
 	      		                [50, 100, 200, 500, -1],
 	      		                ['50 rows', '100 rows', '200 rows', 'Show all']
 	      		            ],
 	      		         scrollY: '80vh',
	      		            scrollX: true,   	      		            
	      		       		responsive: false,
	                		searching: true
 	      		            });
          	        }
          	        
          	    }
          	    else if (response.Message === "No Data") {
      	        	$('#pageLoader').hide();
      	            Swal.fire({
      	                icon: 'warning',
      	                title: response.data,
      	                text: 'No data available for the selected criteria.'
      	            });
      	        }           	    
          	    else {
          	    	$('#pageLoader').hide();
          	        Swal.fire({
          	            icon: 'error',
          	            title: 'Error',
          	            text: response.message || 'Something went wrong!'
          	        });
          	    }
          	},

             error: function (error) {
             	$('#pageLoader').hide();
             	Swal.fire({
  	            icon: 'error',
  	            title: 'Error',
  	            text: response.message || 'Something went wrong!'
  	        });
             }
         });
	 }
	
	</script>

</body>
</html>