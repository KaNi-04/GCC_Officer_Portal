<!DOCTYPE html>
<html lang="en" dir="">
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/modules/base/head :: head}">
	<style>
		label {
			font-weight: 700;
			color: #2d5263;
		}

		
		.custom-file-upload {
			position: relative;
			display: flex;
			align-items: center;
			border: 1px solid #d9dde4;
			border-radius: 5px;
			padding: 5px;
			background-color: #f9fafb;
			cursor: pointer;
			margin-top: 5px;
		}

		.custom-file-upload input[type="file"] {
			position: absolute;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			opacity: 0;
			cursor: pointer;
		}

		.custom-file-upload label {
			display: flex;
			justify-content: space-between;
			width: 100%;
			align-items: center;
		}

		.upload-text {
			color: #a6adb5;

			font-weight: 700;
		}

		.upload-icon i {
			color: #a6adb5;
			font-size: 18px;
		}

		.file-name {
			margin-left: 10px;
			color: #414f69;
			font-size: 14px;

		}
	</style>
</head>

<body>
	<!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

	<div class="wrapper">
		<!-- header top menu Start -->
		<header th:replace="~{fragments/modules/base/header :: header}"></header>
		<!-- header top menu end -->

		<div class="page-wrap">
			<!--=============== Left Menu side Start ================-->
			<div th:replace="~{fragments/modules/base/menu :: menu}"></div>
			<!--=============== Left side End ================-->
			<div class="main-content">
				<div class="container-fluid">
					<div class="page-header">
						<div class="row align-items-end">
							<div class="col-lg-6">
								<div class="page-header-title">
									<i class="ik ik-thumbs-up bg-blue"></i>
									<div class="d-inline">
										<h5>NULM STAFF</h5>
										<span>Create Order</span>
									</div>
								</div>
							</div>
							<div class="col-lg-6">
								<nav class="breadcrumb-container" aria-label="breadcrumb">
									<ol class="breadcrumb">
										<li class="breadcrumb-item">
											<a href="/index"><i class="ik ik-home"></i></a>
										</li>
										<li class="breadcrumb-item active" aria-current="page">Create Order</li>
									</ol>
								</nav>
							</div>
						</div>
					</div>

					<hr>
					<div class="row align-items-center justify-content-center"
						style="color: white;background-color:#414f69 ;padding: 10px;">
						<h3 class="title resizable-content">Create Order</h3>
					</div>
					

						<div class="mt-1">

						</div>
						<!-- Card Section -->
						<div class="card p-3 resizable-content" style="margin-bottom: 8px;color: #414f69;">


							<!-- Add the resizable-content class to the card sections -->
							<div class="card mb-3 resizable-content">
								<!--<div class="card-header text-white" style="background-color: #414f69;font-size: large;font-weight: 700;">Order Details
								</div>-->
								<div class="card-body">
									<div class="row">
										<div class="col-md-6">
											<label style="font-size: large;font-weight: 700;">Order Number:</label>
											<input type="text" class="form-control" id="orderNumber" value=""
												placeholder="Enter Order Number" style="font-size: large;">
										</div>
										<div class="col-md-6">
											<label style="font-size: large;font-weight: 700;">Order Date:</label>
											<input type="date" class="form-control" id="orderDate" value="" style="font-size: large;">
										</div>
										<!--<div class="col-md-6">
											<label style="font-size: large;font-weight: 700;">Order Given By:</label>
											<select type="email" class="form-control" id="orderGeneratedBy" value=""
												 style="font-size: large;">
												<option value="select">select</option>
												<option value="council">Council</option>
												<option value="commissioner">Commissioner</option>
												</select>
										</div>-->
										<div class="col-md-6">
											<label style="font-size: large;font-weight: 700;">Order Given By:</label>
											<input type="text" class="form-control" id="orderGeneratedBy" value=""
												placeholder="Enter Order Given By" style="font-size: large;">
										</div>									
										
										<div class="col-md-6">
											<label style="font-size: large;font-weight: 700;">Order Description:</label>
											<textarea class="form-control" id="details" rows="1"
												placeholder="description..." maxlength="400" style="font-size: large;"></textarea >
										</div>
										<div class="col-md-6">
												<label style="font-size: large;font-weight: 700;">Number Of Staff Required:</label>
												<input type="number" class="form-control" value=""
														placeholder="Enter Staff Required..." style="font-size: large;">
										</div>
										<div class="col-md-6">
												<label style="font-size: large;font-weight: 700;">Validity Date:</label>
												<input type="date" class="form-control" value=""
														placeholder="Enter Validity date" style="font-size: large;">
										</div>
										<div class="col-md-6">
											<label style="font-size: large;font-weight: 700;">Order Document:</label>
											<div class="custom-file-upload">
												<input type="file" id="file-upload" class="form-control"
													onchange="displayFileName()" style="font-size: large;">
												<label for="file-upload" id="file-label">
													<span class="upload-text" id="upload-text">Upload Order
														Document</span>
													<span class="upload-icon">
														<i class="fas fa-file-upload"></i>
													</span>
												</label>
												<span id="file-name" class="file-name"></span>
											</div>
										</div>
										
										<div class="col-md-6">
											<label style="font-size: large;font-weight: 700;">Enter Category:</label>
											<input type="text" class="form-control" id="category" value=""
												placeholder="Enter Category Name" style="font-size: large;">
										</div>


									</div>
								</div>
								<div class="d-flex justify-content-center">
								    <button class="btn"
								        style="background-color: #414f69; color: white; width: 200px;padding: 10px;margin-bottom: 10px;"
								        id="createorder">
								      Submit
								    </button>
								    <button class="btn"
								        style="background-color: #6c757d; color: white; width: 200px;padding: 10px;margin-bottom: 10px;margin-left: 10px;"
								        id="viewdetails">
								        View Details
								    </button>
								</div>

								<div id="detailsContainer" style="margin-top: 20px;"></div>

							</div>
							



						</div>




					

				</div>


			</div>
			<footer th:replace="~{fragments/modules/base/footer :: footer}"></footer>
		</div>
	</div>
	<div th:replace="~{fragments/modules/pgr/modal-box :: div}"></div>

	<div th:replace="~{fragments/modules/base/app_module_menu_box :: div}"></div>

	<script th:replace="~{fragments/modules/base/script :: script}"></script>
	<script th:replace="~{fragments/modules/pgr/script :: script}"></script>
<script th:inline="javascript">

    function displayFileName() {
        const fileInput = document.getElementById('file-upload');
        const fileNameSpan = document.getElementById('file-name');

        // Validate file
        const allowedExtensions = ['pdf', 'doc', 'docx', 'png', 'jpg', 'jpeg'];
        const maxSize = 20 * 1024 * 1024; // 20 MB
        const file = fileInput.files[0];
        
        if (file) {
            const fileName = file.name;
            const fileSize = file.size;
            const fileExtension = fileName.split('.').pop().toLowerCase();

            // Check file type
            if (!allowedExtensions.includes(fileExtension)) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Unsupported file type! Please upload a PDF, Word, or image file.'
                });
                fileInput.value = ''; // Reset the file input
                fileNameSpan.textContent = '';
                return;
            }

            // Check file size
            if (fileSize > maxSize) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'File size exceeds 20MB! Please upload a smaller file.'
                });
                fileInput.value = ''; // Reset the file input
                fileNameSpan.textContent = '';
                return;
            }

            fileNameSpan.textContent = fileName; // Show the file name if valid
        } else {
            fileNameSpan.textContent = ''; // Reset if no file
        }
    }

    $(document).ready(function() {
        $('#createorder').click(function(e) {
            e.preventDefault();

            // Get the file input
            const fileInput = document.getElementById('file-upload');
            const file = fileInput.files[0];

            // Validate file before proceeding
            if (file) {
                const allowedExtensions = ['pdf', 'doc', 'docx', 'png', 'jpg', 'jpeg'];
                const maxSize = 20 * 1024 * 1024; // 20 MB
                const fileName = file.name;
                const fileSize = file.size;
                const fileExtension = fileName.split('.').pop().toLowerCase();

                // Check file type
                if (!allowedExtensions.includes(fileExtension)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Unsupported file type! Please upload a PDF, Word, or image file.'
                    });
                    return;
                }

                // Check file size
                if (fileSize > maxSize) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'File size exceeds 20MB! Please upload a smaller file.'
                    });
                    return;
                }
            }

            // Create FormData object
            const formData = new FormData();

            // Append form data
            formData.append('order_number', document.getElementById('orderNumber').value);
            formData.append('order_date', document.getElementById('orderDate').value);
            formData.append('order_generated_by', document.getElementById('orderGeneratedBy').value);
            formData.append('order_description', document.getElementById('details').value);
            formData.append('no_of_staffs', document.querySelector('input[placeholder="Enter Staff Required..."]').value);
            formData.append('validity_date', document.querySelector('input[placeholder="Enter Validity date"]').value);
            formData.append('category', document.getElementById('category').value);

            // Append file if selected and valid
            if (file) {
                formData.append('ordercopyurl', file);
            }

            // Send AJAX request
            $.ajax({
                url: '/gcc/api/nulm/saveOrder',
                type: 'POST',
                processData: false,  // Required for FormData
                contentType: false,  // Required for FormData
                data: formData,
                success: function(response) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: response,
                    }).then(function() {
                        location.reload(); // Reload the page after the user clicks 'OK'
                    });
                },
                error: function(xhr, status, error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: xhr.responseText || 'An error occurred while saving the order.'
                    });
                }
            });
        });
    });


    $('#viewdetails').click(function(e) {
        e.preventDefault();

        $.ajax({
            url: '/gcc/api/nulm/getAllOrders', // Assuming this is your endpoint for fetching all orders
            type: 'GET',
            success: function(data) {
                displayTable(data);
            },
            error: function(xhr, status, error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Could not retrieve order details'
                });
            }
        });
    });

	function displayTable(data) {
	    console.log(data);  // Inspect the structure of the API response

	    let tableHtml = `
	         <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Order Number</th>
                    <th>Order Date</th>
                    <th>Order Given By</th>
                    <th>Order Description</th>
                    <th>Number Of Staffs</th>
                    <th>Validity Date</th>
                    <th>Appointed</th>
                    <th>Available</th>
                    <th>Category</th>
                </tr>
            </thead>
            <tbody>
	    `;

	    data.forEach(item => {
			
			 const imageUrl = `/gcc/api/nulm/getOrderDocument/${item.order_copy_url}`;
	        tableHtml += `
	            <tr>
	                <td>${item.order_number || ''}</td>
	                <td>${item.order_date || ''}</td>
	                <td>${item.order_generated_by || ''}</td>
	                <td>${item.order_description || ''}</td>
	                <td>${item.no_of_staffs || ''}</td>
	                <td>${item.validity_date || ''}</td>
	                <td>${item.appointed_yes_count || 0}</td>
	                <td>${item.output_value || 0}</td>
	                <td>${item.category || 0}</td>
	              
	            </tr>
	        `;
	    });

	    tableHtml += `
	            </tbody>
	        </table>
	    `;

	    document.getElementById('detailsContainer').innerHTML = tableHtml;
	}


</script>
</body>

</html>