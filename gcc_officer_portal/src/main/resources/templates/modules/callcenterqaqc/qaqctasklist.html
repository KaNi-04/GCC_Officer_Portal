<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/modules/base/head :: head}">

</head>
<style> 
 .required{
	color: red;
}
.card-box {
       	box-shadow: rgba(0, 0, 0, 0.5) 0px 3px 8px;
       	
    }
    
@media (max-width: 768px) {
    .card-box {
        text-align: center;
    }

}		
</style>
<body>
    <div class="wrapper">
        <!-- Header -->
        <header th:replace="~{fragments/modules/base/header :: header}"></header>

        <div class="page-wrap">
            <!-- Left Menu -->
            <div th:replace="~{fragments/modules/base/menu :: menu}"></div>

            <div class="main-content">
                <div class="container-fluid">
                    <div class="page-header">
                        <div class="row align-items-end">
                            <div class="col-lg-6">
                                <div class="page-header-title">
                                    <i class="fa fa-list-alt bg-blue"></i>
                                    <div class="d-inline">
                                        <h5>QAQC Task List</h5>
                                        <span>1913 QAQC Task List</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <nav class="breadcrumb-container" aria-label="breadcrumb">
                                    <ol class="breadcrumb">
                                        <li class="breadcrumb-item">
                                            <a href="/gcc/index"><i class="ik ik-home"></i></a>
                                        </li>
                                        <li class="breadcrumb-item" aria-current="page">1913 Reports</li>																				
                                        <li class="breadcrumb-item active" aria-current="page">QAQC Task List</li>
                                    </ol>
                                </nav>
                            </div>
                        </div>
                    </div>
					
	                <div class="row mt-4">
	                	
	                	<div class="col-md-12">
                             <div class="card">
                             	<div class="card-header">
                             		<h3>Task Details</h3>
                             	</div>
                             	
                          	<div class="row mt-3 ml-2">
									    <div class="col-md-3">
									    	<label for="startDate" class="form-label" style="font-size: medium;">From Date:</label>
									        <input type="date" id="startDate" class="form-control" placeholder="Start Date">
									    </div>
									    <div class="col-md-3">
									    	<label for="endDate" class="form-label" style="font-size: medium;">To Date:</label>
									        <input type="date" id="endDate" class="form-control" placeholder="End Date">
									    </div>
									    <div class="col-md-3" style="margin-top: 30px;">
									        <button id="searchBtn" class="btn btn-primary">Search</button>
									        <button id="resetBtn" class="btn btn-secondary">Reset</button>
									    </div>
									</div>
					   				
					   				<div class="card-body">
					   				<div>
					   					<div class="row mt-2"> 
					   					
					   							                  	                  	
                    						<div class="col-xl-3 col-md-3 col-sm-12">
												<div class="card card-box p-4">                   			
					                    				<h6 class="text-facebook mb-20 mt-2 text-center"><b>Total Task</b></h6>
                    									<h4 class="text-twitter fw-700 text-center" id="totaltask"></h4>                   			
                    							</div>                   	
                    						</div>  
                    						<div class="col-xl-3 col-md-3 col-sm-12">
												<div class="card card-box p-4">                   			
					                    				<h6 class="text-facebook mb-20 mt-2 text-center"><b>Assigned Calls</b></h6>
                    									<h4 class="text-twitter fw-700 text-center" id="totalcalls"></h4>                   			
                    							</div>                   	
                    						</div>
                    						<div class="col-xl-3 col-md-3 col-sm-12">
												<div class="card card-box p-4">                   			
					                    				<h6 class="text-facebook mb-20 mt-2 text-center"><b>Finished</b></h6>
                    									<h4 class="text-twitter fw-700 text-center" id="completedcalls"></h4>                   			
                    							</div>                   	
                    						</div>
                    						<div class="col-xl-3 col-md-3 col-sm-12">
												<div class="card card-box p-4">                   			
					                    				<h6 class="text-facebook mb-20 mt-2 text-center"><b>Pending Calls</b></h6>
                    									<h4 class="text-twitter fw-700 text-center" id="pendingcalls"></h4>                   			
                    							</div>                   	
                    						</div>                  						                	                   	                  	
                 						</div>
                 						
                 						<div>               							
                 							<table id="QaqcDatatable" class="table table-striped table-bordered table-hover dataTable" role="grid" >
							                    <thead class="thead-dark">
											        <tr role="row">
							                            <th rowspan="2" class="text-center" width="1%;">S.No</th>
							                            <th rowspan="2" class="text-center no-sort">Task ID</th>
							                            <th rowspan="2" class="text-center" width="100px;">Date</th> 
							                            <th rowspan="2" class="text-center no-sort">Category</th>
							                            <!-- <th rowspan="2" class="text-center">Description</th> -->
							                            <th colspan="4" class="text-center">Performance</th>
							                            <th colspan="4" class="text-center">Call Results</th>
							                            
							                        </tr>
							                        <tr role="row">           
							                            <!-- <th class="text-center">S.No</th> 
							                            <th class="text-center">Task ID</th>  -->
							                            
							                            <th class="text-center no-sort">Assigned Calls</th>							                            
							                            <th class="text-center no-sort">Finished</th>
							                            <th class="text-center no-sort">Pending Calls</th>
							                            <th class="text-center no-sort">Completion(%)</th>
							                            <th class="no-sort">Completed</th> 
							                            <th class="no-sort">Reopen</th>
							                            <th class="no-sort">Followup</th>
							                            <th class="no-sort">Others</th>
							                        </tr>
							                    </thead>
							                    <tbody>
							                        
							                    </tbody>
							                </table>
                 						</div>
                 						
					   				</div>
                             	</div>						 
							 </div>
                         </div> 
					</div>	               	
             						 					  
			</div> 
        </div>
   
   
 				<div id="pageLoader" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 9999; text-align: center;">
				    <div style="position: relative; top: 50%; transform: translateY(-50%);">
				        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
				            <span class="sr-only">Loading...</span>
				        </div>
				        <!-- Add the 'Please wait' text below the spinner -->
				        <p style="margin-top: 1rem; font-size: 1.2rem; color: #007bff;">Please wait...</p>
				    </div>
				</div>  
   
     <footer th:replace="~{fragments/modules/base/footer :: footer}"></footer>
      </div>
</div>


<!--agentperformance Modal -->
		<div class="modal fade" id="agentperformance" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalCenterLabel">Task Details</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    </div>
                    
                    <div class="modal-body">
                    
                    <div class="modal-info"></div>
						<div class="table-responsive" >
						<table id="agentperformanceDatatable" class="table table-striped table-bordered table-hover dataTable" role="grid" >
                              <thead class="thead-dark">
                                 	<tr role="row">
                            <th rowspan="2" class="text-center">S.No</th>
                            <th rowspan="2" class="text-center">Agent Name</th>                           
                            <th colspan="4" class="text-center">Performance</th>
                            <th colspan="4" class="text-center">Call Results</th>
                        </tr>
                        <tr role="row">          
                            <th class="text-center">Assigned Calls</th>
                            <th class="text-center">Finished</th>
                            <th class="text-center">Pending Calls</th>
                            <th class="text-center">Completion (%)</th>
                            <th class="text-center">Completed</th>
                            <th class="text-center">Reopen</th>
                            <th class="text-center">Followup</th>
                            <th class="text-center">Others</th>
                            
                        </tr>
						 </thead>
                         <tbody>
                                    
                         </tbody>
                               
                       </table>
						</div>
                     </div>
  					
  					<div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        
                    </div>                                        
                </div>
            </div>
        </div>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script th:replace="~{fragments/modules/base/script :: script}"></script>
        <!--  sweet alert -->
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script type="text/javascript">	
 	 $(document).ready(function() {
 		 
 		 $('#agentperformance').on('shown.bs.modal', function () {

 	    	 var buttons = [
 	             {
 	                 extend: 'pageLength',
 	                 className: 'btn btn-warning'
 	             },
 	             {
 	                 title: 'Data export',
 	                 extend: 'copyHtml5',
 	                 text: 'Copy',
 	                 className: 'btn btn-secondary'
 	             },
 	             {
 	                 extend: 'excelHtml5',
 	                 text: 'Excel',
 	                 className: 'btn btn-secondary'
 	             },
 	             {
 	                 extend: 'csvHtml5',
 	                 text: 'CSV',
 	                 className: 'btn btn-secondary'
 	             },
 	             {
 	                 extend: 'pdfHtml5',
 	                 text: 'PDF',
 	                 className: 'btn btn-secondary'
 	             }
 	         ];
 	        
 	            $('#agentperformanceDatatable').DataTable({
 	                dom: 'Bftip',               
 	                columnDefs: [
 	                    { targets: 'no-sort', orderable: false }
 	                ],
 	                lengthMenu: [
 	                    [50, 100, 200, 500, -1],
 	                    ['50 rows', '100 rows', '200 rows', '500 rows', 'Show all']
 	                ],
 	                scrollY: '30vh',
 	                scrollX: true,  // Enable horizontal scrolling	
 	                fixedColumns: {
 	                    left: 1,
 	                    right: 1
 	                },
 	                buttons: buttons,
 	                fixedHeader: false,
 	                autoWidth: false,
 	                responsive: true,
 	                searching: true,
 	                select: false,
 	                processing: false,
 	            });
 	        
 	        
 	    });

     	var table = $('#QaqcDatatable').DataTable({
             dom: 'Bftip',
             columnDefs: [
                 { targets: 'no-sort', orderable: false }
             ],
             lengthMenu: [
                 [50, 100, 200, 500, -1],
                 ['50 rows', '100 rows', '200 rows', 'Show all']
             ],
             scrollY: '50vh',
             buttons: [
                 {
                     extend: 'pageLength',
                     className: 'btn btn-warning'
                 },
                 {
                     title: 'Data export',
                     extend: 'copyHtml5',
                     text: 'Copy',
                     className: 'btn btn-secondary',
                     id: 'copyBtn'
                 },
                 {
                     extend: 'excelHtml5',
                     text: 'Excel',
                     className: 'btn btn-secondary',
                     id: 'excelBtn'
                 },
                 {
                     extend: 'csvHtml5',
                     text: 'CSV',
                     className: 'btn btn-secondary',
                     id: 'csvBtn'
                 },
                 {
                     extend: 'pdfHtml5',
                     text: 'PDF',
                     className: 'btn btn-secondary',
                     id: 'pdfBtn'
                 }
             ],
             fixedHeader: false,
             autoWidth: true,
             responsive: true,
             searching:true,
             select: false,
             processing: false
         });
    	
     	 // Initialize DataTable with export buttons

            const overallcountapiUrl = "/gcc/api/callcenterqaqc/qaqctasklist/overalltaskcount"; // Replace with your API endpoint
		    const tableApiUrl = "/gcc/api/callcenterqaqc/qaqctasklist/taskdatacount";
            const agentApiUrl = "/gcc/api/callcenterqaqc/qaqctasklist/agentdatacount";
		    const totaltasks = document.getElementById("totaltask");
		    const totalcallsassigned = document.getElementById("totalcalls");
		    const completedcallscount = document.getElementById("completedcalls");
		    const pendingcallscount = document.getElementById("pendingcalls");
		    const dataTableElement = $("#QaqcDatatable").DataTable(); // Initialize DataTable

		    
		    // Fetch Data Function
		    const fetchData = async (startDate = "", endDate = "") => {
		    	
		        try {
		            const params = new URLSearchParams();
		            if (startDate) params.append("startDate", startDate);
		            if (endDate) params.append("endDate", endDate);

		            const response = await fetch(`${overallcountapiUrl}?${params.toString()}`);
		            const data = await response.json();
					
		            //console.log(data);
		            // Update Summary Counts
		            const firstItem = data[0];  // Get the first object from the array
		            totaltasks.textContent = firstItem.total_tasks || 0; 
		            totalcallsassigned.textContent = firstItem.total_calls || 0; 
		            completedcallscount.textContent = firstItem.completed_calls || 0;  
		            pendingcallscount.textContent = firstItem.pending_calls || 0; 
             } catch (error) {
		            console.error("Error fetching data:", error);
		        }
		    };
		    

    // Fetch and Populate Table Data Function
    const fetchTableData = async (startDate = "", endDate = "") => {
    	$('#pageLoader').show();
        try {
            const params = new URLSearchParams();
            if (startDate) params.append("startDate", startDate);
            if (endDate) params.append("endDate", endDate);

            const response = await fetch(`${tableApiUrl}?${params.toString()}`);
            const tableData = await response.json();

            // Update DataTable with new data
            table.clear(); // Clear existing data
            tableData.forEach((row, index) => {
                const percentage = row.Assigned
                    ? Math.round((row.TotalCompleted / row.Assigned) * 100)
                    : 0;

                table.row.add([
                	
                	`<div style="text-align: center;">${index + 1}</div>`,
                	`<button class="btn btn-success" data-taskid="${row.qaqc_id}" 
                    onclick="handleTaskButtonClick('${row.qaqc_id}')">${row.taskid}</button>`,
                    `<div style="text-align: center;">${row.TaskCreatedDate}</div>`,
                    `<div style="text-align: center;">${row.call_category}</div>`,
                    /* `<div style="text-align: center;">${row.description}</div>`, */                                      
                    `<div style="text-align: center;">${row.Assigned}</div>`,
                    `<div style="text-align: center;">${row.TotalCompleted}</div>`,
                    `<div style="text-align: center;">${row.Pending}</div>`,
                    `<div style="text-align: center;">${percentage}%</div>`,
                    `<div style="text-align: center;">${row.Completed}</div>`,
                    `<div style="text-align: center;">${row.Reopened}</div>`,
                    `<div style="text-align: center;">${row.Followup}</div>`,
                    `<div style="text-align: center;">${row.Others}</div>`,
                ]);
                
            });
            table.draw(); // Redraw the DataTable with the updated data
      
        } catch (error) {
            console.error("Error fetching table data:", error);
        }finally {
            $('#pageLoader').hide(); // Hide loader in both success or error
        }
    };

    // Example: Fetch Data initially without filters
    //fetchTableData();
    
 

		    // Search Button Click
		    document.getElementById("searchBtn").addEventListener("click", () => {
		        let startDate = document.getElementById("startDate").value;
		        let endDate = document.getElementById("endDate").value;
		        
		        if (!startDate || !endDate) {
	     	        // Show SweetAlert if dates are missing
	     	        Swal.fire({
	     	            icon: 'warning', // Warning icon
	     	            title: 'Please select both dates.',
	     	            showConfirmButton: true, // Show a confirmation button
	     	            timer: 3000 // Optional: Auto-close after 3 seconds
	     	        });

	     	        e.preventDefault(); // Prevent form submission if validation fails
	     	        return;
	     	    }
		        
		        fetchData(startDate, endDate);
		        fetchTableData(startDate,endDate);
		        
		        
		    });

		    // Reset Button Click
		    document.getElementById("resetBtn").addEventListener("click", () => {
		        /* document.getElementById("startDate").value = "";
		        document.getElementById("endDate").value = "";
		        fetchData(); // Fetch data without date filters
		        fetchTableData(); */
 		        window.location.href = "/gcc/callcenterqaqcreports/qaqctasklist";		        
		    });
		    
		 

		    let today = new Date();

			// Get the first day of the current month (this should give 2024-11-01 for November)
			let firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

			// Manually format the date as yyyy-mm-dd without relying on toISOString
			let formattedFirstDay = firstDayOfMonth.getFullYear() + '-' + 
			                        (firstDayOfMonth.getMonth() + 1).toString().padStart(2, '0') + '-' + 
			                        firstDayOfMonth.getDate().toString().padStart(2, '0');

			let formattedToday = today.getFullYear() + '-' + 
			                     (today.getMonth() + 1).toString().padStart(2, '0') + '-' + 
			                     today.getDate().toString().padStart(2, '0');

		    // Set the date input values
		    $('#startDate').val(formattedFirstDay);
		    $('#endDate').val(formattedToday);
		    
		    $('#endDate').attr('min', formattedFirstDay); // Initial minimum for To Date
		    $('#startDate').attr('max', formattedToday); // Initial maximum for From Date
		    

		    // Update To Date's min attribute when From Date changes
		    $('#startDate').on('change', function () {
		        const fromDate = $(this).val();
		        $('#endDate').attr('min', fromDate); // Update min attribute for To Date

		        // If To Date is earlier than the new From Date, adjust it
		        const toDate = $('#endDate').val();
		        if (new Date(toDate) < new Date(fromDate)) {
		            $('#endDate').val(fromDate);
		        }
		    });

		    // Update From Date's max attribute when To Date changes
		    $('#endDate').on('change', function () {
		        const toDate = $(this).val();
		        $('#startDate').attr('max', toDate); // Update max attribute for From Date

		        // If From Date is later than the new To Date, adjust it
		        const fromDate = $('#startDate').val();
		        if (new Date(fromDate) > new Date(toDate)) {
		            $('#startDate').val(toDate);
		        }
		    });
		    
		    // Initial Load
		   // Call fetch functions with default values
		    //fetchData();
		    //fetchTableData();
		    fetchData(formattedFirstDay, formattedToday);
		    fetchTableData(formattedFirstDay, formattedToday);
		});
 	 
 	 function handleTaskButtonClick(TaskId)
 	 {
 		 //console.log("TaskId",TaskId);
 		 		 
 		 
 		$('#agentperformance').modal({
            backdrop: 'static',
            keyboard: false
        });
        $('#agentperformance').modal('show');
        
     // Clear old data from the table
 	    if ($.fn.DataTable.isDataTable('#agentperformanceDatatable')) {
 	        $('#agentperformanceDatatable').DataTable().clear().destroy();
 	    }
 		 
        $.ajax({
            url: '/gcc/api/callcenterqaqc/qaqctasklist/agentdatacount?qaqc_id='+TaskId,
            type: 'GET',
            contentType: 'application/json',
            success: function (response) {
            	//console.log("response",response);
            	if (response && response.length > 0) {
            		
	            	let CtableBody = $('#agentperformanceDatatable tbody');
	            	CtableBody.empty();
            	response.forEach((item, index) => {
            		const modalHeader = `
                        <h5 class="modal-title" id="exampleModalCenterLabel">
                            Task Details - <span>Task ID: ${item.taskId}</span> and
                            <span>Created Date: ${item.TaskCreatedDate}</span>
                            
                        </h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    `;
                    $('.modal-header').html(modalHeader);
                    
                 // Updating the modal body with additional details
                    const modalBodyDetails = `
                    <div class="mt-1" style="font-size: 14px;">
                        <div class="row pb-2">
                            <div class="col-md-6"><strong>From Date:</strong> ${item.fromdate || 'N/A'}</div>
                            <div class="col-md-6"><strong>To Date:</strong> ${item.todate || 'N/A'}</div>
                        </div>
                        <div class="row pb-2">
                            <div class="col-md-6"><strong>Description:</strong> ${item.description || 'N/A'}</div>
                            <div class="col-md-6"><strong>Call Category:</strong> ${item.call_category || 'N/A'}</div>
                        </div>
                        <div class="row pb-2">
	                        <div class="col-md-6"><strong>Complaint Group:</strong> ${item.complaint_group || 'N/A'}</div>
	                        <div class="col-md-6"><strong>Complaint Type:</strong> ${item.complaint_type || 'N/A'}</div>
                    	</div>
                    	<div class="row pb-2">
	                        <div class="col-md-6"><strong>Complaint Mode:</strong> ${item.complaint_mode || 'N/A'}</div>
	                        <div class="col-md-6"><strong>Complaint Zone:</strong> ${item.complaint_zone || 'N/A'}</div>
                		</div>
                		<div class="row pb-2">
                			<div class="col-md-6"><strong>Complaint Region:</strong> ${item.complaint_region || 'N/A'}</div>
                		</div>
                	</div>
                        <hr>
                    `;
                    $('.modal-info').html(modalBodyDetails); // Insert the details before the table
                    
            		let row = `
            			<tr>
                        <td class="text-center">${index + 1}</td>
                        <td class="text-center">${item.agentName}</td>
                        <td class="text-center">${item.assigned || 0}</td>
                        <td class="text-center">${item.callstaken || 0}</td>
                        <td class="text-center">${item.pending || 0}</td>
                        <td class="text-center">${item.percentage || 0}%</td>
                        <td class="text-center">${item.Completed || 0}</td>
                        <td class="text-center">${item.Reopened || 0}</td>
                        <td class="text-center">${item.Followup || 0}</td>
                        <td class="text-center">${item.Others || 0}</td>
                    </tr>
                `;
            		CtableBody.append(row); 
            	});
            	}
            	else {
                    $('#agentperformanceDatatable tbody').html(`
                        <tr>
                            <td colspan="10" class="text-center">No data available</td>
                        </tr>
                    `);
                }
            	 
            },
            error: function (xhr, status, error) {
                console.error('Error in Fetching Task:', error);
                $('#agentperformanceDatatable tbody').html(`
                        <tr>
                            <td colspan="10" class="text-center text-danger">Failed to load data</td>
                        </tr>
                    `);
            }
        });
 		 
 	 }

/*  	$(document).ready(function () {
 		
 	// Event listener for From Date selection
		   $("#startDate").on("change", function() {
		       const startDate = $(this).val();  // Get the selected start date
		       // Set the min value for To Date to be the selected From Date
		       $("#endDate").attr("min", startDate);
		   });

		   // Event listener for To Date selection
		   $("#endDate").on("change", function() {
		       const endDate = $(this).val();  // Get the selected end date
		       // Set the max value for From Date to be the selected To Date
		       $("#startDate").attr("max", endDate);
		   });
 		
 	}); */
    
	</script>



</body>
</html>