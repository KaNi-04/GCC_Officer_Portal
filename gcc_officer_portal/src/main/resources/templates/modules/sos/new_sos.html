<!DOCTYPE html>
<html lang="en" dir="">
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/modules/base/head :: head}"></head>
    <body>
    <style>
        html,
        body,
        #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }

        
        label {
            display: block;
            margin: 5px 0 2px;
            font-weight: bold;
        }

        select,
        input {
            width: 100%;
            padding: 5px;
        }

        #resetButton {
            margin-top: 10px;
            padding: 10px;
            background-color: #ff5733;
            color: white;
            border: none;
            cursor: pointer;
        }

        #resetButton:hover {
            background-color: #e04e1d;
        }
    </style>
    <link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css">
        <!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <div class="wrapper">
			<!-- header top menu Start -->
			 <header th:replace="~{fragments/modules/base/header :: header}"></header>
			<!-- header top menu end -->

            <div class="page-wrap">
				<!--=============== Left Menu side Start ================-->
				<div th:replace="~{fragments/modules/base/menu :: menu}"></div>
				<!--=============== Left side End ================-->
                <div class="main-content">
                    <div class="container-fluid">
                        <div class="page-header">
                            <div class="row align-items-end">
                                <div class="col-lg-8">
                                    <div class="page-header-title">
                                        <i class="far fa-calendar-plus bg-blue"></i>
                                        <div class="d-inline">
                                            <h5>SOS</h5>
                                            <span>Add SOS Request</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <nav class="breadcrumb-container" aria-label="breadcrumb">
                                        <ol class="breadcrumb">
                                            <li class="breadcrumb-item">
                                                <a href="index"><i class="ik ik-home"></i></a>
                                            </li>
                                            <li class="breadcrumb-item" aria-current="page">SOS</li>
                                            <li class="breadcrumb-item active" aria-current="page">Add SOS Request</li>
                                        </ol>
                                    </nav>
                                </div>
                            </div>
                        </div>
                        <hr>
                        
                        <div class="row">
                        	<div class="col-md-2"></div>
							<div class="col-md-12">
                                <div class="card">
									<form class="request-form" id="request-form" onsubmit="return saveRequest();">
	                                    <div class="card-header"><h3>New SOS Request Form</h3></div>
	                               		<div class="card-body">
											<div class="row">	 
							                     <div class="col-lg-6">
													<div class="form-group">
														<label for="contact_names">Requester Name :</label> 
														<input type="text" id="contact_name" name="contact_name" class="form-control" placeholder="Name" required>
													</div>
												</div>
												<div class="col-lg-6">
													<div class="form-group">
														<label for="contact_number">Requester Contact Number :</label> 
														<input type="text" id="contact_number" name="contact_number" class="form-control" placeholder="Contact Number" required>
													</div>
												</div>
												<div class="col-12">
											    	<div id="viewDiv" style="width: 100%; height: 600px;"> &nbsp;</div>
												</div>
												<div id="infoContainer">
												        <div id="infoDiv">
												            <label for="zoneInput">Zone:</label>
												            <input type="text" id="zoneInput" placeholder="Zone" readonly>
												
												            <label for="wardInput">Ward:</label>
												            <input type="text" id="wardInput" placeholder="Ward" readonly>
												
												            <label for="roadInput">Road Name:</label>
												            <input type="text" id="roadInput" placeholder="Road Name" readonly>
												
												            <label for="addressInput">Address:</label>
												            <input type="text" id="addressInput" placeholder="Address" readonly>
												
												            <label for="latInput">Latitude:</label>
												            <input type="text" id="latInput" placeholder="Latitude" readonly>
												
												            <label for="longInput">Longitude:</label>
												            <input type="text" id="longInput" placeholder="Longitude" readonly>
												
												            <label for="roadBufferSelect">Roads within Area:</label>
												            <select id="roadBufferSelect">
												                <option value="">Select Road</option>
												            </select>
												
												            <button id="resetButton">Reset Map</button>
												        </div>
												    </div>
												<div class="col-lg-6">
													<div class="form-group">
			                                            <label for="zone">Select Zone</label>
			                                            <select class="form-control" id="zone" name="zone" style="width: 100%;" data-placeholder="தேர்ந்தெடு.." onchange="get_ward_list(this.value);" required>
															<option value=""></option>
														</select>
			                                        </div>
		                                      	</div>
	                                        	<div class="col-lg-6">
			                                        <div class="form-group">
			                                            <label for="ward">Select Ward</label>
			                                            <select class="form-control" id="ward" name="ward" style="width: 100%;" data-placeholder="தேர்ந்தெடு.." required  onchange="get_councillor_details(this.value);">
															<option value=""></option>
														</select>
			                                        </div>
	                                        	</div>
	                                        	
	                                        	<div class="col-lg-6">
													<div class="form-group">
			                                            <label for="request_type">Select Request Type</label>
			                                            <select class="form-control" id="request_type" name="request_type" style="width: 100%;" data-placeholder="தேர்ந்தெடு.." required>
															<option value=""></option>
															<option value="Rescue">Rescue</option>
															<option value="Medical">Medical</option>
															<option value="Food">Food</option>
														</select>
			                                        </div>
		                                      	</div>
	                                        	<div class="col-lg-6">
			                                        <div class="form-group">
			                                            <label for="no_of_count">No Of People Count</label>
			                                            <input type="text" class="form-control" id="no_of_count" name="no_of_count" style="width: 100%;" data-placeholder="தேர்ந்தெடு.." required>
			                                        </div>
	                                        	</div>
											</div>
	                                        
											<div class="form-group">
												<label for="subject">Remarks :</label>
												<textarea class="form-control" name="remarks" id="remarks" rows="5" placeholder="Remarks if any" data-autosize-input='{ "space": 40 }'></textarea>
											</div>
	                                        
										</div>	 
	                                  	<div class="card-footer text-right">
	                                  		<input type="hidden" id="mode" name="mode" value="1913">
											<button type="reset" class="btn btn-secondary mr-2" id="resetFormBtn"><i class="ik ik-refresh-cw"></i>Reset</button>
                                        	<button type="submit" class="btn btn-success" id="requestSubmitBtn"><i class="ik ik-save"></i>Save</button>
	                                	</div>
                                	</form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <footer th:replace="~{fragments/modules/base/footer :: footer}"></footer>
            </div>
        </div>
       
        
        <div th:replace="~{fragments/modules/base/app_module_menu_box :: div}"></div>
       	
        <script th:replace="~{fragments/modules/base/script :: script}"></script>
        <script th:replace="~{fragments/modules/circular/script :: script}"></script>
        
   		<script src="https://js.arcgis.com/4.30/"></script>
       	<script th:inline="javascript">
			var createdBy = /*[[${LoginUserId}]]*/'';
			
	        /* Get Zone and Ward Data */
	        function get_zone_ward_data(){
	        	get_zone_ward_list().then(function(zoneWard) {
	    		    // Handle the zoneward list
	    		    zoneWardList = zoneWard;
					
	    		    // Iterate through the department list and add options to the select element
	    		    $.each(zoneWardList, function(index, zoneWards) {
	    	            // Create an option element
	    	            var option = $('<option>', {
	    	            	value: zoneWards.zone, // case-sensitive as per object
	    	                text: "Zone "+ zoneWards.zone
	    	            });
	    	            // Append the option to the select element
	    	            $('#zone').append(option);
	    	        });
	    		    
	    		}).catch(function(error) {
	    		    // Handle errors
	    		    console.error('Error fetching complaint type list:', error);
	    		});
			}
			
	        /* Get Ward List */
	        function get_ward_list(zone) {

	            // Assuming get_zone_ward_list() returns a promise that resolves to the zoneWardList
	            get_zone_ward_list().then(function(zoneWard) {
	                // Handle the zoneWard list
	                zoneWardList = zoneWard;
	                
	                // Clear any existing options in the ward dropdown
	                $('#ward').empty();
	                
	                var option = $('<option>', {
                        value:"" ,  // Set ward number as the value
                        text:""  // Display as "Ward 1", "Ward 2", etc.
                    });
	                
	                $('#ward').append(option);
	                
	                $('#councillorName').val('');
					$('#councillorMobile').val('');
					
	            	 // Find the correct zone in the zoneWardList
	                var selectedZone = zoneWardList.find(function(zoneWards) {	                    
						return zoneWards.zone == zone;  // Compare the zone value
	                });
	                // If the zone is found, iterate over its wards and add options
	                if (selectedZone) {
	                    var wardsArray = selectedZone.wards.split(',');  // Split wards string into array
	                    $.each(wardsArray, function(index, ward) {
	                        // Create an option element
	                        option = $('<option>', {
	                            value: ward.trim(),  // Set ward number as the value
	                            text: 'Ward ' + ward.trim()  // Display as "Ward 1", "Ward 2", etc.
	                        });
	                        // Append the option to the select element
	                        $('#ward').append(option);
	                    });
	                } else {
	                    console.error('Zone not found');
	                }

	            }).catch(function(error) {
	                // Handle errors
	                console.error('Error fetching ward list:', error);
	            });
	        }
	        
	        /* Zone and Ward List */
	    	function get_zone_ward_list() {
	    	    
	    		var apiUrl = '/gcc/api/sos/getZoneAndWard';
	    	    // Return a Promise
	    	    return new Promise(function(resolve, reject) {
	    	        $.ajax({
	    	            url: apiUrl,
	    	            type: 'GET',
	    	            dataType: 'json',
	    	            success: function(jsonResponse) {
	    	                // Resolve the Promise with the department list
	    	                resolve(jsonResponse);
	    	            },
	    	            error: function(xhr, status, error) {
	    	                // Reject the Promise with the error message
	    	                reject(error);
	    	            }
	    	        });
	    	    });
	    	}
	        
			// Save New petition 
			function saveRequest(){
				// Disable the button to prevent multiple clicks
				form_btn_disable();
				
				var inputElementComplaintType = $('#request_type');
				var request_type = inputElementComplaintType.val();
				var loginId = $('#contact_number').val();
				if (request_type && loginId) {
					
					// Serialize form data
			        var formData = new FormData($('#request-form')[0]);
			        formData.append('createdBy',createdBy);
			        formData.append('loginId',loginId);
			        saveFormData(formData).then(function(response) {
			        	const status = response[0].status;
						if(status!="error"){
							// Handle the response
		    		    	Swal.fire({
		        				title: 'Rescue data saved successfully.',
		        				customClass: {
		        			        title: 'swal-title-custom' // Add a custom class for the title
		        			    },
		        				//text: "Error",
		        				icon: 'success',
		        				showCancelButton: false,
		        				confirmButtonColor: '#3085d6',
		        				cancelButtonColor: '#d33',
		        				confirmButtonText: 'Ok',
		        				}).then(function(result) {
		        				if (result.isConfirmed) {
		        					// Reload the current page
		        					//location.reload();
		        					// Navigate to a Ack page
		        					window.location = "/gcc/sos/new";
		        				}
		        			});
						}
						else{
							// Handle the response
							// if response == "error"
		    		    	Swal.fire({
		        				title: 'Failed to save rescue data. Please try again!',
		        				customClass: {
		        			        title: 'swal-title-custom' // Add a custom class for the title
		        			    },
		        				//text: "Error",
		        				icon: 'error',
		        				showCancelButton: false,
		        				confirmButtonColor: '#3085d6',
		        				cancelButtonColor: '#d33',
		        				confirmButtonText: 'Ok',
		        				}).then(function(result) {
		        				if (result.isConfirmed) {
		        					form_btn_enable();
		        				}
		        			});
						}
		    		    
	    		    	
		    	    }).catch(function(error) {
		    		    // Handle errors
		    		    console.error('Error on save circular:', error.message);
		    		    form_btn_enable();
	    			});
				}
				else{
					//inputElementMobileNo.addClass('is-invalid');
					form_btn_enable();
				}
				return false;
			}
			
			function saveFormData(formData){
				var apiUrl = '/gcc/api/sos/saveRequest';
			    // Return a Promise
			    return new Promise(function(resolve, reject) {
					$.ajax({
						url: apiUrl,
					    type: 'POST',
					    data: formData,
					    processData: false,
					    contentType: false,
					    success: function(response) {
					        console.log(response);
					        // Handle success response
					        resolve(response);
					    },
					    error: function(xhr, status, error) {
					        console.error('Error:', error);
					        // Handle error response
					        reject(error);
					    }
					});
			    });
			}
			
			function form_btn_enable(){
				$("#resetFormBtn").prop("disabled", false);
				$("#requestSubmitBtn").prop("disabled", false);
				$("#requestSubmitBtn").html('<i class="ik ik-save"></i>Save');
			}
			
			function form_btn_disable(){
				$("#resetFormBtn").prop("disabled", true);
				$("#requestSubmitBtn").prop("disabled", true);
				// Show the loading icon on the button
				$("#requestSubmitBtn").html('<i class="fas fa-spinner fa-spin"></i> Validating your request, please wait...');
			}
			
			$(document).ready(function() {
				//get_circular_type_data();
				get_zone_ward_data();
				//get_department_data();
				//$('#petitionerMobile').mask('0000000000');
			});
		</script>
		
		<script>
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/FeatureLayer",
            "esri/widgets/Search",
            "esri/geometry/geometryEngine",
            "esri/Graphic",
            "esri/widgets/LayerList",
            "esri/widgets/Legend",
            "esri/geometry/projection"
        ], function (Map, MapView, FeatureLayer, Search, geometryEngine, Graphic, LayerList, Legend, projection) {

            // Create the map and view
            const map = new Map({
                basemap: "streets"
            });

            const view = new MapView({
                container: "viewDiv",
                map: map,
                center: [80.237617, 13.067439],
                zoom: 12
            });

            // Define the road layer (FeatureLayer) to query
            const roadLayer = new FeatureLayer({
                url: "https://gisgcc.chennaicorporation.gov.in/server/rest/services/GCCDepts/APIRoadsMap/FeatureServer/0",
                outFields: ["zone", "ward", "road_name", "address"],
                renderer: {
                    type: "simple",
                    symbol: {
                        type: "simple-line",
                        color: "red",
                        width: 0.5
                    }
                },
                popupTemplate: {
                    title: "{road_name}",
                    content: "Zone: {zone}<br>Ward: {ward}<br>Address: {address}"
                }
            });

            map.add(roadLayer);

            const searchWidget = new Search({
                view: view
            });

            const layerList = new LayerList({
                view: view
            });

            // Add widgets to view
            view.ui.add(layerList, {
                position: "top-right"
            });

            const legend = new Legend({
                view: view
            });
            view.ui.add(legend, {
                position: "bottom-right"
            });
            view.ui.add(searchWidget, "top-right");

            // Create a point graphic and store the reference to it for later use
            let pointGraphic = null;
            let highlightGraphic = null;  // To store the highlighted road graphic

            // Event listener for map click on the basemap
            view.on("click", function (event) {
				reset();
                const clickedPoint = event.mapPoint; // Capture the clicked point

                // Update latitude and longitude fields
                document.getElementById("latInput").value = clickedPoint.latitude.toFixed(6);
                document.getElementById("longInput").value = clickedPoint.longitude.toFixed(6);

                // Create a buffer around the clicked point (500 meters)
                const buffer = geometryEngine.buffer(clickedPoint, 50, "meters");

                // Query the road layer for roads within the buffer
                const query = roadLayer.createQuery();
                query.geometry = buffer;  // Use the buffer geometry to filter results
                query.spatialRelationship = "intersects";
                query.outFields = ["road_name"];  // Only fetch road names
                query.returnGeometry = false;

                roadLayer.queryFeatures(query).then(function (result) {
                    const roadNames = result.features.map(function (feature) {
                        return feature.attributes.road_name;
                    });

                    // Populate the dropdown with road names
                    populateDropdown(roadNames);
                }).catch(function (error) {
                    console.error("Query failed: ", error);
                });

                // Create a new point graphic to show the clicked location
                if (pointGraphic) {
                    view.graphics.remove(pointGraphic); // Remove the old graphic if it exists
                }

                pointGraphic = new Graphic({
                    geometry: clickedPoint,
                    symbol: {
                        type: "simple-marker",
                        color: "blue",
                        size: "14px"
                    }
                });

                view.graphics.add(pointGraphic); // Add the point graphic to the map
            });

            // Function to populate the dropdown with road names
            function populateDropdown(roadNames) {
				
                const dropdown = document.getElementById("roadBufferSelect");
                dropdown.innerHTML = ''; // Clear existing dropdown items
                
                const defaultOption = document.createElement("option");
                defaultOption.text = "Select a road";
                dropdown.appendChild(defaultOption);
                roadNames.sort();
				
                // Populate the dropdown with the queried road names
                if (roadNames.length > 0) {
                    roadNames.forEach(function (roadName) {
                        const option = document.createElement("option");
                        option.value = roadName;
                        option.text = roadName;
                        dropdown.appendChild(option);
                    });
                } else {
                    const noRoadsOption = document.createElement("option");
                    noRoadsOption.text = "No roads found within 500m";
                    dropdown.appendChild(noRoadsOption);
                }
            }

            // When a user selects a road from the dropdown, fetch additional details (zone, ward, address) and zoom to the road
            document.getElementById("roadBufferSelect").addEventListener("change", function (event) {
                const selectedRoadName = event.target.value;
                if (selectedRoadName) {
                    // Query the road layer to get the details and geometry of the selected road
                    const query = roadLayer.createQuery();
                    query.where = `road_name = '${selectedRoadName}'`;  // Query for the selected road name
                    query.outFields = ["zone", "ward", "address"];  // Get zone, ward, and address
                    query.returnGeometry = true;  // We need the geometry to zoom to the road

                    roadLayer.queryFeatures(query).then(function (result) {
                        if (result.features.length > 0) {
                            const roadDetails = result.features[0].attributes;
                            const roadGeometry = result.features[0].geometry;

                            // Populate the fields with the road details
                            document.getElementById("zoneInput").value = roadDetails.zone || "";
                            document.getElementById("wardInput").value = roadDetails.ward || "";
                            document.getElementById("addressInput").value = roadDetails.address || "";
                            document.getElementById("roadInput").value = selectedRoadName;  // Populate the road name field
							
							/*
			                alert(document.getElementById("zoneInput").value);
			                alert(document.getElementById("wardInput").value);
			                alert(document.getElementById("addressInput").value);
			                alert(document.getElementById("roadInput").value);
			                alert(document.getElementById("latInput").value);
			                alert(document.getElementById("longInput").value);
			                alert(document.getElementById("roadBufferSelect").value);
							*/
                            // Zoom to the selected road with level 15
                            view.goTo({
                                target: roadGeometry,
                                zoom: 15
                            });

                            // Highlight the road
                            if (highlightGraphic) {
                                view.graphics.remove(highlightGraphic);  // Remove the previous highlight if any
                            }

                            highlightGraphic = new Graphic({
                                geometry: roadGeometry,
                                symbol: {
                                    type: "simple-line",
                                    color: "green",
                                    width: 4
                                }
                            });

                            view.graphics.add(highlightGraphic); // Add the highlight graphic to the map
                        }
                    }).catch(function (error) {
                        console.error("Error fetching road details: ", error);
                    });
                } else {
                    // Clear the input fields if no road is selected
                    document.getElementById("zoneInput").value = "";
                    document.getElementById("wardInput").value = "";
                    document.getElementById("addressInput").value = "";
                    document.getElementById("roadInput").value = "";
                }
            });

            // Reset map (clear the point graphic and highlighted road)
            document.getElementById("resetButton").addEventListener("click", function () {
                if (pointGraphic) {
                    view.graphics.remove(pointGraphic); // Remove the point graphic
                    pointGraphic = null; // Reset the point graphic variable
                }
                if (highlightGraphic) {
                    view.graphics.remove(highlightGraphic); // Remove the highlight graphic
                    highlightGraphic = null; // Reset the highlight graphic variable
                }
                // Clear input fields
                document.getElementById("zoneInput").value = "";
                document.getElementById("wardInput").value = "";
                document.getElementById("addressInput").value = "";
                document.getElementById("roadInput").value = "";
                document.getElementById("latInput").value = "";
                document.getElementById("longInput").value = "";
                document.getElementById("roadBufferSelect").value = "";
            });
			
			function reset(){
                
                // Clear input fields
                document.getElementById("zoneInput").value = "";
                document.getElementById("wardInput").value = "";
                document.getElementById("addressInput").value = "";
                document.getElementById("roadInput").value = "";
                //document.getElementById("latInput").value = "";
                //document.getElementById("longInput").value = "";
                document.getElementById("roadBufferSelect").value = "";
			}
			
			
			
        });
		/*
		function test(){
            alert(document.getElementById("zoneInput").value);
            alert(document.getElementById("wardInput").value);
            alert(document.getElementById("addressInput").value);
            alert(document.getElementById("roadInput").value);
            alert(document.getElementById("latInput").value);
            alert(document.getElementById("longInput").value);
            alert(document.getElementById("roadBufferSelect").value);
		}*/
    </script>
    </body>
</html>
