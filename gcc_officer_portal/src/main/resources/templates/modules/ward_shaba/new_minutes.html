<!DOCTYPE html>
<html lang="en" dir="">
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/modules/base/head :: head}"></head>

<body>
	<!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

	<div class="wrapper">
		<!-- header top menu Start -->
		<header th:replace="~{fragments/modules/base/header :: header}"></header>
		<!-- header top menu end -->

		<div class="page-wrap">
			<!--=============== Left Menu side Start ================-->
			<div th:replace="~{fragments/modules/base/menu :: menu}"></div>
			<!--=============== Left side End ================-->
			<div class="main-content">
				<div class="container-fluid">
					<div class="page-header">
						<div class="row align-items-end">
							<div class="col-lg-8">
								<div class="page-header-title">
									<i class="far fa-calendar-plus bg-blue"></i>
									<div class="d-inline">
										<h5>Add New Minutes</h5>
										<span>Ward Sabha Minutes</span>
									</div>
								</div>
							</div>
							<div class="col-lg-4">
								<nav class="breadcrumb-container" aria-label="breadcrumb">
									<ol class="breadcrumb">
										<li class="breadcrumb-item">
											<a href="index"><i class="ik ik-home"></i></a>
										</li>
										<li class="breadcrumb-item" aria-current="page">Ward Sabha Minutes</li>
										<li class="breadcrumb-item active" aria-current="page">Add Minutes</li>
									</ol>
								</nav>
							</div>
						</div>
					</div>
					<hr>
					<div class="row">
						<div class="col-md-2"></div>
						<div class="col-md-8">
							<div class="card">
								<form class="request-form" id="request-form" onsubmit="return saveRequest();"
									enctype="multipart/form-data">
									<div class="card-header">
										<h3>New Minutes Form</h3>
									</div>
									<div class="card-body" id="card-body">
										<div class="row">
											<div class="col-lg-12">
												<div class="form-group">
													<label for="eventid">Select Current Minutes / தற்போதைய நிகழ்வை
														தேர்ந்தெடுக்கவும்</label>
													<select class="form-control" id="eventid" name="eventid"
														style="width: 100%;" data-placeholder="தேர்ந்தெடு.."
														th:attr="data-selected=${eventId}" required>
														<option value="">Select</option>
														<option th:if="${eventName}" th:value="${eventId}"
															th:text="${eventName}" selected ></option>
													</select>
												</div>
											</div>
											<input class="form-control" id="zone" name="zone" style="width: 100%;" type="hidden" value="00">
											<input class="form-control" id="ward" name="ward" style="width: 100%;" type="hidden" value="000">
											
										</div>

										<div class="form-group">
											<label for="complaintNature">நிமிட விவரங்களை உள்ளிடவும் / Enter Minutes
												Details</label>
											<textarea class="form-control" id="complaintNature" name="complaintNature"
												rows="6" placeholder="நிமிட விவரங்களை உள்ளிடவும்..." required></textarea>
										</div>
										<div class="card-footer text-right">
											<button type="reset" class="btn btn-secondary mr-2" id="resetFormBtn"><i
													class="ik ik-refresh-cw"></i>Reset</button>
											<button type="submit" class="btn btn-success" id="requestSubmitBtn"><i
													class="ik ik-save"></i>Save</button>
										</div>
								</form>
							</div>
						</div>
						<div class="col-md-2"></div>
					</div>
				</div>
			</div>

			<footer th:replace="~{fragments/modules/base/footer :: footer}"></footer>
		</div>
	</div>


	<div th:replace="~{fragments/modules/base/app_module_menu_box :: div}"></div>

	<script th:replace="~{fragments/modules/base/script :: script}"></script>
	<!--<script th:replace="~{fragments/modules/zerohours_petition/script :: script}"></script>-->
	<script th:inline="javascript">
		var createdBy = /*[[${LoginUserId}]]*/'';
		var ward = /*[[${myWard}]]*/'';
		
		var complaintTypeList = "";
		var zoneList = "";
		var wardList = "";

		/* Get Event Data */


		// Save New petition 
		function saveRequest() {
			// Disable the button to prevent multiple clicks
			form_btn_disable();

			var inputElementMobileNo = $('#petitionerMobile');
			var mobileNo = inputElementMobileNo.val();
			var mobileFormatRegex = /^\d{10}$/; //'0000000000';
			inputElementMobileNo.removeClass('is-invalid');

			var inputElementComplaintType = $('#complaintType');
			var complaintType = inputElementComplaintType.val();

			if (mobileNo !== null) {

				// Serialize form data
				var formData = new FormData($('#request-form')[0]);
				formData.append('createdBy', createdBy);
				saveFormData(formData).then(function (response) {
					if (response != "error") {
						// Handle the response
						Swal.fire({
							title: 'Petition data saved successfully.',
							customClass: {
								title: 'swal-title-custom' // Add a custom class for the title
							},
							//text: "Error",
							icon: 'success',
							showCancelButton: false,
							confirmButtonColor: '#3085d6',
							cancelButtonColor: '#d33',
							confirmButtonText: 'Ok',
						}).then(function (result) {
							if (result.isConfirmed) {
								// Reload the current page
								//location.reload();
								// Navigate to a Ack page
								//window.location = "/gcc/zerohours_petition/petition-ack/"+response;
								window.location = "/gcc/ward_shaba/new_minutes";
							}
						});
					}
					else {
						// Handle the response
						// if response == "error"
						Swal.fire({
							title: 'Failed to save petition data. Please try again!',
							customClass: {
								title: 'swal-title-custom' // Add a custom class for the title
							},
							//text: "Error",
							icon: 'error',
							showCancelButton: false,
							confirmButtonColor: '#3085d6',
							cancelButtonColor: '#d33',
							confirmButtonText: 'Ok',
						}).then(function (result) {
							if (result.isConfirmed) {
								form_btn_enable();
							}
						});
					}


				}).catch(function (error) {
					// Handle errors
					console.error('Error on save petition:', error.message);
					form_btn_enable();
				});
			}
			else {
				inputElementMobileNo.addClass('is-invalid');
				form_btn_enable();
			}
			return false;
		}

		function saveFormData(formData) {
			var apiUrl = '/gcc/api/ward_shaba/savePetition';

			return new Promise(function (resolve, reject) {
				$.ajax({
					url: apiUrl,
					type: 'POST',
					data: formData,
					processData: false,
					contentType: false,
					success: function (response) {
						console.log("API Response:", response); // Debugging log

						if (response.minutes_no) { // ✅ Ensure JSON key is correct
							Swal.fire({
								title: "Success",
								text: "Form submitted successfully. Minutes No: " + response.minutes_no,
								icon: "success",
								confirmButtonText: "OK"
							}).then(() => {
								$("#minutesNo").text(response.minutes_no);
								window.location.reload();
							});
						} else {
							Swal.fire({
								title: "Error",
								text: "Minutes No is missing from response",
								icon: "error",
								confirmButtonText: "OK"
							});
						}
					},
					error: function (xhr, status, error) {
						console.error('Error:', xhr.responseText); // ✅ Log error response
						Swal.fire({
							title: "Error",
							text: xhr.responseText || "Failed to save minutes!",
							icon: "error",
							confirmButtonText: "OK"
						});
						reject(error);
					}
				});
			});
		}

		$(document).ready(function () {
			console.log("Document is ready. Fetching event list...");

			// Fetch Minutes Names in Dropdown
			$.ajax({
				url: '/gcc/api/ward_shaba/getMinutesNames?ward='+ward,
				type: 'GET',
				success: function (response) {
					console.log("API Response:", response);

					let dropdown = $('#eventid');
					dropdown.empty().append('<option value="Select">Select</option>');

					if (!response || response.length === 0) {
						console.warn("No events found.");
						return;
					}

					$.each(response, function (index, item) {
						let selected = item.minutes_id == $('#eventid').attr('data-selected') ? "selected" : "";
						dropdown.append(`<option value="${item.minutes_id}" ${selected}>${item.minutes_name}</option>`);
					});

					// Fetch details after dropdown is populated
					const selectedEventId = dropdown.attr('data-selected');
					if (selectedEventId) {
						fetchMinutesDetails(selectedEventId);
					}
				},
				error: function (xhr) {
					console.error("Error fetching minutes names:", xhr.responseText);
				}
			});

		});

		$(document).ready(function () {
			// Get URL parameters
			const urlParams = new URLSearchParams(window.location.search);
			const eventId = urlParams.get('eventid');

			if (eventId) {
				console.log("Event ID from URL:", eventId);
				$('#eventid').attr('data-selected', eventId);
				// fetchMinutesDetails(eventId);
			}
		});
		// Fetch minutes details when dropdown changes
		$('#eventid').change(function () {
			var selectedMinutes = $('#eventid').val();

			if (!selectedMinutes || selectedMinutes === "Select") {
				console.warn("Invalid selection");
				return;
			}

			//fetchMinutesDetails(selectedMinutes);
		});
		function form_btn_enable() {
			$("#resetFormBtn").prop("disabled", false);
			$("#requestSubmitBtn").prop("disabled", false);
			$("#requestSubmitBtn").html('<i class="ik ik-save"></i>Save');
		}

		function form_btn_disable() {
			$("#resetFormBtn").prop("disabled", true);
			$("#requestSubmitBtn").prop("disabled", true);
			// Show the loading icon on the button
			$("#requestSubmitBtn").html('<i class="fas fa-spinner fa-spin"></i> Validating your request, please wait...');
		}

		$(document).ready(function () {
			get_event_data();
			/*get_zone_ward_data();
			get_complaint_type_data();
			$('#petitionerMobile').mask('0000000000');*/
		});


	</script>
</body>

</html>