<!DOCTYPE html>
<html lang="en" dir="">
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/modules/base/head :: head}"></head>
    <body>
        <!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <div class="wrapper">
			<!-- header top menu Start -->
			 <header th:replace="~{fragments/modules/base/header :: header}"></header>
			<!-- header top menu end -->

            <div class="page-wrap">
				<!--=============== Left Menu side Start ================-->
				<div th:replace="~{fragments/modules/base/menu :: menu}"></div>
				<!--=============== Left side End ================-->
                <div class="main-content">
                    <div class="container-fluid">
                        <div class="page-header">
                            <div class="row align-items-end">
                                <div class="col-lg-8">
                                    <div class="page-header-title">
                                        <i class="far fa-calendar-plus bg-blue"></i>
                                        <div class="d-inline">
                                            <h5>Add New Circular</h5>
                                            <span>Circular / Minutes</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <nav class="breadcrumb-container" aria-label="breadcrumb">
                                        <ol class="breadcrumb">
                                            <li class="breadcrumb-item">
                                                <a href="index"><i class="ik ik-home"></i></a>
                                            </li>
                                            <li class="breadcrumb-item" aria-current="page">Circular & Minutes</li>
                                            <li class="breadcrumb-item active" aria-current="page">Add New</li>
                                        </ol>
                                    </nav>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                        	<div class="col-md-2"></div>
							<div class="col-md-8">
                                <div class="card">
									<form class="request-form" id="request-form" onsubmit="return saveRequest();" enctype="multipart/form-data">
	                                    <div class="card-header"><h3>New Circular Form</h3></div>
	                               		<div class="card-body">
											<div class="form-group">
												<label >Document Category :</label> 
												<div class="form-radio" id="doc_cat_txt">
													<div class="radio radiofill radio-inline radio-success">
								                        <label class="cursure_poiter">
								                            <input type="radio" name="doc_cat" value="common" required> <i class="helper"></i>Common
								                        </label>
								                    </div>
		                                       
													<div class="radio radiofill radio-inline radio-primary">
								                        <label class="cursure_poiter">
								                            <input type="radio" name="doc_cat" value="flood" required> <i class="helper"></i>Flood
								                        </label>
								                    </div>
		                                        </div>
											</div>
	                                        <div class="form-group">
												<label>Type :</label> 
												<div class="form-radio" id="circularType"></div>
											</div>
											<div class="row">	 
							                     <div class="col-lg-6">
													<div class="form-group">
														<label for="department">From Department :</label> 
														<select class="form-control" name="department" id="department" required>
															<option value="" selected disabled>Choose Department</option>
														</select>
													</div>
												</div>
											 
							                     <div class="col-lg-6">
													<div class="form-group">
														<label for="Date">Date :</label>
														<input type="date" class="form-control" id="Date" name="Date" oninput="formatDate(this)" required>
													</div>
												</div>
											</div>
											<div class="form-group">
												<label for="subject">Subject :</label>
												<textarea class="form-control" name="subject" id="subject" rows="5" placeholder="Subject" data-autosize-input='{ "space": 40 }'></textarea>
											</div>
	                                        <div class="row">
							                     <div class="col-lg-12">
								                     <div class="form-group">
								                       <label for="scan_page1">Select File :</label>
													   <input name="scan_page1" id="scan_page1" class="form-control" type="file" capture="camera"  accept="application/pdf, image/*">
													 </div>
												 </div>
											</div>
										</div>	 
	                                  	<div class="card-footer text-right">
											<button type="reset" class="btn btn-secondary mr-2" id="resetFormBtn"><i class="ik ik-refresh-cw"></i>Reset</button>
                                        	<button type="submit" class="btn btn-success" id="requestSubmitBtn"><i class="ik ik-save"></i>Save</button>
	                                	</div>
                                	</form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <footer th:replace="~{fragments/modules/base/footer :: footer}"></footer>
            </div>
        </div>
       
        
        <div th:replace="~{fragments/modules/base/app_module_menu_box :: div}"></div>
       	
        <script th:replace="~{fragments/modules/base/script :: script}"></script>
        <script th:replace="~{fragments/modules/circular/script :: script}"></script>
       	<script th:inline="javascript">
			var createdBy = /*[[${LoginUserId}]]*/'';
			var circularTypeList = "";
			 /* Get Complaint Type Data */
	        function get_circular_type_data(){
	
	        	get_circular_type_list().then(function(circularTypes) {
	    		    // Handle the Complaint list
	    		    circularTypeList = circularTypes;
	    		    circularTypeHTML = "";
	    		    // Iterate through the department list and add options to the select element
	    		    $.each(circularTypeList, function(index, circularType) {
	    	            // Create an option element
	    	            circularTypeHTML +=`<div class="radio radiofill ${circularType.color_class} radio-inline">
						                            <label class="cursure_poiter">
						                            <input type="radio" name="circularType" value="${circularType.tid}" required>
						                            <i class="helper"></i>${circularType.name}
						                        </label>
						                    </div>`;
	    	        });
	    		 // Append the option to the select element
    	            $('#circularType').append(circularTypeHTML);
	    		    
	    		}).catch(function(error) {
	    		    // Handle errors
	    		    console.error('Error fetching circular type list:', error);
	    		});
			}
			 
	        /* Get Department Data */
	        function get_department_data(){
	
	    		get_department_list().then(function(departmentList) {
	    		    // Iterate through the department list and add options to the select element
	    		    $.each(departmentList, function(index, department) {
	    	            // Create an option element
	    	            var option = $('<option>', {
	    	            	value: department.did, // case-sensitive as per object
	    	                text: department.name
	    	            });
	    	            // Append the option to the select element
	    	            $('#department').append(option);
	    	        });
	    		    
	    		}).catch(function(error) {
	    		    // Handle errors
	    		    console.error('Error fetching complaint type list:', error);
	    		});
			}
			// Save New petition 
			function saveRequest(){
				// Disable the button to prevent multiple clicks
				form_btn_disable();
				
				var inputElementComplaintType = $('#department');
				var department = inputElementComplaintType.val();
				
				if (department) {
					
					// Serialize form data
			        var formData = new FormData($('#request-form')[0]);
			        formData.append('createdBy',createdBy);
			        saveFormData(formData).then(function(response) {
						if(response!="error"){
							// Handle the response
		    		    	Swal.fire({
		        				title: 'Circular data saved successfully.',
		        				customClass: {
		        			        title: 'swal-title-custom' // Add a custom class for the title
		        			    },
		        				//text: "Error",
		        				icon: 'success',
		        				showCancelButton: false,
		        				confirmButtonColor: '#3085d6',
		        				cancelButtonColor: '#d33',
		        				confirmButtonText: 'Ok',
		        				}).then(function(result) {
		        				if (result.isConfirmed) {
		        					// Reload the current page
		        					//location.reload();
		        					// Navigate to a Ack page
		        					window.location = "/gcc/circular/list";
		        				}
		        			});
						}
						else{
							// Handle the response
							// if response == "error"
		    		    	Swal.fire({
		        				title: 'Failed to save circular data. Please try again!',
		        				customClass: {
		        			        title: 'swal-title-custom' // Add a custom class for the title
		        			    },
		        				//text: "Error",
		        				icon: 'error',
		        				showCancelButton: false,
		        				confirmButtonColor: '#3085d6',
		        				cancelButtonColor: '#d33',
		        				confirmButtonText: 'Ok',
		        				}).then(function(result) {
		        				if (result.isConfirmed) {
		        					form_btn_enable();
		        				}
		        			});
						}
		    		    
	    		    	
		    	    }).catch(function(error) {
		    		    // Handle errors
		    		    console.error('Error on save circular:', error.message);
		    		    form_btn_enable();
	    			});
				}
				else{
					//inputElementMobileNo.addClass('is-invalid');
					form_btn_enable();
				}
				return false;
			}
			
			function saveFormData(formData){
				var apiUrl = '/gcc/api/circular/saveCircular';
			    // Return a Promise
			    return new Promise(function(resolve, reject) {
					$.ajax({
						url: apiUrl,
					    type: 'POST',
					    data: formData,
					    processData: false,
					    contentType: false,
					    success: function(response) {
					        console.log(response);
					        // Handle success response
					        resolve(response);
					    },
					    error: function(xhr, status, error) {
					        console.error('Error:', error);
					        // Handle error response
					        reject(error);
					    }
					});
			    });
			}
			
			function form_btn_enable(){
				$("#resetFormBtn").prop("disabled", false);
				$("#requestSubmitBtn").prop("disabled", false);
				$("#requestSubmitBtn").html('<i class="ik ik-save"></i>Save');
			}
			
			function form_btn_disable(){
				$("#resetFormBtn").prop("disabled", true);
				$("#requestSubmitBtn").prop("disabled", true);
				// Show the loading icon on the button
				$("#requestSubmitBtn").html('<i class="fas fa-spinner fa-spin"></i> Validating your request, please wait...');
			}
			
			$(document).ready(function() {
				get_circular_type_data();
				get_department_data();
				$('#petitionerMobile').mask('0000000000');
			});
		</script>
    </body>
</html>
